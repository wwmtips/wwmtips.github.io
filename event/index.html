<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í–‰ìš´ì˜ ë´‰íˆ¬ ì´ë²¤íŠ¸</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body {
            display: flex; flex-direction: column; align-items: center;
            background-color: #f0f0f0; margin: 0; padding-top: 50px;
            font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif;
            min-height: 100vh;
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-area { margin-bottom: 30px; text-align: center; z-index: 10; }
        .input-nickname { padding: 10px; border: 2px solid #ddd; border-radius: 5px; width: 180px; }
        .start-btn { padding: 10px 20px; background-color: #c41e28; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* ë´‰íˆ¬ ìŠ¤íƒ€ì¼ */
        .envelope-wrapper {
            position: relative; width: 320px; height: 220px;
            pointer-events: none; opacity: 0.6; transition: opacity 0.3s;
            margin-bottom: 50px; 
            margin-top: 150px; /* ì¹´ë“œ ì˜¬ë¼ê°ˆ ê³µê°„ í™•ë³´ */
        }
        .envelope-wrapper.active { pointer-events: auto; opacity: 1; cursor: pointer; }
        
        .shake { animation: shake 2.5s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 5% { transform: rotate(1deg); } 10% { transform: rotate(-1deg); } 25% { transform: rotate(0deg); } }
        
        .envelope { position: relative; width: 100%; height: 100%; background-color: #ba1c26; border-radius: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ (ë†’ì´ ìˆ˜ì •ë¨) */
        .card { 
            position: absolute; 
            left: 15px; right: 15px; bottom: 10px; top: 20px;
            background: white; 
            border: 2px solid #e0aa3e; 
            border-radius: 5px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; 
            z-index: 1; 
            transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            padding: 20px; box-sizing: border-box;
        }
        .card h2 { margin: 0 0 10px 0; font-size: 22px; }
        .card p { margin: 0; color: #555; font-size: 14px; word-break: keep-all; }

        /* â˜… ë‹¹ì²¨ ì½”ë“œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .win-code-box {
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            margin-top: 15px;
            padding: 8px 15px;
            background-color: #fff8e1;
            border: 2px dashed #e0aa3e;
            border-radius: 8px;
            color: #d32f2f;
            font-weight: bold;
            font-size: 18px;
            user-select: all; /* ë“œë˜ê·¸ ë³µì‚¬ ì‰½ê²Œ */
        }

        /* ë‚ ê°œë“¤ */
        .flap-left { position: absolute; top: 0; left: 0; bottom: 0; width: 0; height: 0; border-style: solid; border-width: 110px 0 110px 160px; border-color: transparent transparent transparent #c41e28; z-index: 2; }
        .flap-right { position: absolute; top: 0; right: 0; bottom: 0; width: 0; height: 0; border-style: solid; border-width: 110px 160px 110px 0; border-color: transparent #c41e28 transparent transparent; z-index: 2; }
        .flap-bottom { position: absolute; bottom: 0; left: 0; right: 0; width: 0; height: 0; border-style: solid; border-width: 0 160px 130px 160px; border-color: transparent transparent #d62832 transparent; z-index: 3; }
        .flap-top { position: absolute; top: 0; left: 0; right: 0; width: 0; height: 0; border-style: solid; border-width: 130px 160px 0 160px; border-color: #e3303a transparent transparent transparent; z-index: 4; transform-origin: top; transition: transform 0.6s; }
        .flap-top::after { content: ''; position: absolute; top: -130px; left: -150px; width: 300px; height: 120px; border: 1px solid #f9d675; border-top: none; transform: scaleY(0.8); opacity: 0.5; pointer-events: none; }
        
        .seal { position: absolute; top: 100px; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: radial-gradient(circle, #f9d675 0%, #e0aa3e 100%); border: 2px solid #fff; border-radius: 50%; z-index: 5; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #c41e28; font-size: 20px; transition: opacity 0.3s; }
        .loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid #f3f3f3; border-top: 4px solid #c41e28; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; z-index: 100; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* ì˜¤í”ˆ ì• ë‹ˆë©”ì´ì…˜ (ì¹´ë“œ ë†’ì´ -100pxë¡œ ìˆ˜ì •ë¨) */
        .open .flap-top { transform: rotateX(180deg); z-index: 1; }
        .open .seal { opacity: 0; pointer-events: none; }
        .open .card { transform: translateY(-100px); z-index: 3; transition-delay: 0.4s; }

        /* ëª…ë‹¨ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .list-container {
            width: 90%; max-width: 400px; background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 50px; z-index: 50; 
        }
        .list-title { text-align: center; color: #333; margin: 0 0 15px 0; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .list-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .list-table th { color: #888; text-align: left; padding: 5px; font-weight: normal; }
        .list-table td { padding: 8px 5px; border-bottom: 1px solid #f5f5f5; color: #333; }
        .res-win { color: #d32f2f; font-weight: bold; }
        .res-lose { color: #aaa; }
    </style>
</head>
<body>

    <div class="envelope-wrapper shake" id="envelopeWrapper" onclick="requestResult()">
        <div class="envelope">
            <div class="card">
                <h2 id="resultTitle">?</h2>
                <p id="resultText">í™•ì¸ ì¤‘...</p>
                <div id="codeBox" class="win-code-box"></div>
            </div>
            <div class="flap-left"></div> <div class="flap-right"></div> <div class="flap-bottom"></div> <div class="flap-top"></div> <div class="seal">ç¦</div>
            <div class="loader" id="loader"></div>
        </div>
    </div>

    <div class="input-area" id="inputArea">
        <h3>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”</h3>
        <input type="text" id="nickname" class="input-nickname" placeholder="ì—¬ê¸°ì— ì…ë ¥..." maxlength="8">
        <button class="start-btn" onclick="readyToOpen()">í™•ì¸</button>
    </div>

    <div class="list-container">
        <h4 class="list-title">ğŸ“‹ ìµœê·¼ ì°¸ì—¬ì í˜„í™©</h4>
        <table class="list-table">
            <thead>
                <tr>
                    <th width="25%">ì‹œê°„</th>
                    <th width="40%">ë‹‰ë„¤ì„</th>
                    <th width="35%" style="text-align:right">ê²°ê³¼</th>
                </tr>
            </thead>
            <tbody id="listBody">
                <tr><td colspan="3" style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // â˜…â˜…â˜… êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš” â˜…â˜…â˜…
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwri9pIRIer_sxDsjJIjr1zE5rlnWhhEy0EgM6knOBO4X7TazREbihq_WLJ-Iq_k_-G/exec"; 

        let isReady = false;
        let isOpened = false;
        let currentUser = "";

        // í˜ì´ì§€ ì—´ë¦¬ìë§ˆì ëª…ë‹¨ ë¡œë“œ
        window.onload = function() { loadList(); };

        function readyToOpen() {
            const input = document.getElementById('nickname');
            if (!input.value.trim()) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
            currentUser = input.value.trim();
            document.getElementById('inputArea').style.display = 'none';
            document.getElementById('envelopeWrapper').classList.add('active');
            isReady = true;
        }

        function requestResult() {
            if (!isReady || isOpened) return;
            
            const wrapper = document.getElementById('envelopeWrapper');
            const loader = document.getElementById('loader');
            const title = document.getElementById('resultTitle');
            const text = document.getElementById('resultText');
            const codeBox = document.getElementById('codeBox');

            wrapper.classList.remove('shake');
            loader.style.display = 'block';

            // 1. IP í™•ì¸
            fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(ipData => {
                const userIp = ipData.ip;
                // 2. ì„œë²„ ìš”ì²­
                return fetch(`${GAS_SCRIPT_URL}?action=play&id=${encodeURIComponent(currentUser)}&ip=${userIp}`);
            })
            .then(response => response.text())
            .then(data => {
                loader.style.display = 'none';

                // ì¢…ë£Œ ì¡°ê±´ ì²´í¬
                if (data === "GAMEOVER") {
                    alert("ğŸ“¢ ì´ë¯¸ ë‹¹ì²¨ìê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤!\nì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    text.innerText = "ì´ë²¤íŠ¸ ì¢…ë£Œ";
                    wrapper.classList.remove('active');
                    wrapper.style.opacity = "0.5";
                    loadList(); 
                    return; 
                }

                isOpened = true;
                
                // ë°ì´í„° íŒŒì‹± ("WIN:ì½”ë“œ" ë˜ëŠ” "HISTORY:WIN:ì½”ë“œ")
                let finalResult = data;
                let finalCode = "";
                let isHistory = false;

                if (data.startsWith("HISTORY:")) {
                    isHistory = true;
                    // ì˜ˆ: HISTORY:WIN:LUCKY2025
                    const parts = data.split(":");
                    finalResult = parts[1]; // WIN ë˜ëŠ” LOSE
                    if(parts.length > 2) finalCode = parts[2]; // ì½”ë“œ
                } else if (data.startsWith("WIN:")) {
                    // ì˜ˆ: WIN:LUCKY2025
                    const parts = data.split(":");
                    finalResult = "WIN";
                    finalCode = parts[1];
                }

                // ê²°ê³¼ í™”ë©´ í‘œì‹œ
                if (finalResult === "WIN") {
                    if(isHistory) {
                        title.innerText = "ì°¸ì—¬ ì™„ë£Œ"; title.style.color = "#d32f2f";
                        text.innerHTML = "ì´ë¯¸ ë‹¹ì²¨ë˜ì…¨ìŠµë‹ˆë‹¤!<br>ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                    } else {
                        title.innerText = "ğŸ‰ ëŒ€í˜‘! ğŸ‰"; title.style.color = "#d32f2f";
                        text.innerHTML = "ì¦ê±°ìš´ ì£¼ë§ ë³´ë‚´ì‹œì˜¤. ì†ì´ê°€ë„ ì†ì´ ê°€ëŠ” ìƒˆìš°ê¹¡ì´ì˜¤!";
                    }
                    
                    // ì½”ë“œ í‘œì‹œ
                    if(finalCode) {
                        codeBox.innerText = finalCode; // ì½”ë“œë§Œ ê¹”ë”í•˜ê²Œ í‘œì‹œ
                        codeBox.style.display = "block";
                    }

                } else {
                    if(isHistory) {
                        title.innerText = "ì°¸ì—¬ ì™„ë£Œ"; title.style.color = "#555";
                        text.innerHTML = "ì´ë¯¸ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤.<br>(ê²°ê³¼: ê½)";
                    } else {
                        title.innerText = "ë‹¹ì²¨ì´ì˜¤?"; title.style.color = "#555";
                        text.innerHTML = "êµ¬ë¥˜ë¬¸ì— ë“¤ì–´ì˜¬ ê¸°íšŒë¥¼ ì£¼ê² ì†Œ<br>ë1ì´ì˜¤!";
                    }
                }

                wrapper.classList.add('open');
                loadList(); // ëª…ë‹¨ ê°±ì‹ 
            })
            .catch(err => {
                loader.style.display = 'none';
                alert("ì˜¤ë¥˜ ë°œìƒ. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                wrapper.classList.add('shake');
            });
        }

        // ëª…ë‹¨ ë¦¬ìŠ¤íŠ¸ í•¨ìˆ˜
        function loadList() {
            fetch(`${GAS_SCRIPT_URL}?action=list`)
            .then(res => res.json())
            .then(list => {
                const tbody = document.getElementById('listBody');
                tbody.innerHTML = ""; 

                if(list.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:20px;'>ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                    return;
                }

                list.forEach(item => {
                    const tr = document.createElement('tr');
                    const resClass = item.result === "WIN" ? "res-win" : "res-lose";
                    const resText = item.result === "WIN" ? "ğŸ‰ í–‰ìš´ë´‰íˆ¬" : "ì‚¬ë¦¬ë´‰";
                    
                    tr.innerHTML = `
                        <td>${item.time}</td>
                        <td>${item.name}</td>
                        <td style="text-align:right" class="${resClass}">${resText}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }
    </script>
</body>
</html>