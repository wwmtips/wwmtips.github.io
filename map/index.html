<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ìš´ ëŒ€ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../map_style.css">
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. ë§µ ë°ì´í„°ë² ì´ìŠ¤ (ì„¤ì •)
        // ==========================================
        // â˜… ì—¬ê¸°ì— ë§µì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ í•œ ì¤„ì”© ì ìœ¼ë©´ ë©ë‹ˆë‹¤.
        const mapsDB = {
            "qinghe": {
                name: "ì²­í•˜",
                img: "../qinghe.jpg",       // ì´ë¯¸ì§€ ê²½ë¡œ
                json: "../json/qinghe.json", // ë°ì´í„° ê²½ë¡œ (íŒŒì¼ëª… ë³€ê²½ ê¶Œì¥)
                w: 7306, h: 4732            // ì´ë¯¸ì§€ í¬ê¸°
            },
            "kaifeng": {
                name: "ê°œë´‰",
                img: "../kaifeng.jpg",      // (ì˜ˆì‹œ)
                json: "../json/kaifeng.json",
                w: 8000, h: 6000            // (ì˜ˆì‹œ í¬ê¸°)
            }
        };

        // ==========================================
        // 2. í˜„ì¬ ì–´ë–¤ ë§µì„ ë³´ì—¬ì¤„ì§€ ê²°ì •
        // ==========================================
        // URLì—ì„œ ?id=qinghe ê°™ì€ íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const urlParams = new URLSearchParams(window.location.search);
        let currentMapId = urlParams.get('id');

        // ë§Œì•½ idê°€ ì—†ê±°ë‚˜ ì´ìƒí•˜ë©´ ê¸°ë³¸ê°’ 'qinghe'ë¡œ ì„¤ì •
        if (!currentMapId || !mapsDB[currentMapId]) {
            currentMapId = "qinghe";
        }

        const currentConfig = mapsDB[currentMapId];
        document.title = `${currentConfig.name} - ì—°ìš´ ì§€ë„`; // ë¸Œë¼ìš°ì € íƒ­ ì œëª© ë³€ê²½

        // ì•„ì´ì½˜ ì„¤ì •
        const config = {
            iconSize: [30, 30]
        };

        const typeMapping = {
            "ê²½ê³„ì„": "stone", "ìƒì": "chest", "ë§Œì‚¬ë¡": "ic_mansa", "ë³´ìŠ¤": "boss"
        };
        
        const allMarkers = {};

        // ==========================================
        // 3. ì§€ë„ ì´ˆê¸°í™”
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 2,
            zoomSnap: 0.5,
            zoomDelta: 0.5,
            zoomControl: false,
            attributionControl: false 
        });

        // ì„¤ì •ëœ ë§µ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        const bounds = [[0, 0], [currentConfig.h, currentConfig.w]];
        L.imageOverlay(currentConfig.img, bounds).addTo(map);

        // ì´ˆê¸° í™”ë©´ ì¤‘ì•™ ì •ë ¬
        map.setView([currentConfig.h / 2, currentConfig.w / 2], -2.5);


        // ==========================================
        // 4. ì»¨íŠ¸ë¡¤ ë°°ì¹˜
        // ==========================================
        
        // [ì¤Œ] ìš°ì¸¡ í•˜ë‹¨
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // [ì „ì²´í™”ë©´] ì¢Œì¸¡ í•˜ë‹¨
        const FullscreenControl = L.Control.extend({
            options: { position: 'bottomleft' },
            onAdd: function () {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const btn = L.DomUtil.create('a', 'leaflet-control-fullscreen', container);
                btn.href = '#'; btn.innerHTML = 'â›¶'; btn.title = "ì „ì²´í™”ë©´";
                btn.onclick = (e) => { e.preventDefault(); toggleFullscreen(); };
                return container;
            }
        });
        map.addControl(new FullscreenControl());

        // [ë§µ ë³€ê²½ ë©”ë‰´] ìš°ì¸¡ ìƒë‹¨ â˜… í•µì‹¬ ë¶€ë¶„
        const MapSwitcherControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function () {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control map-switcher-control');
                
                const icon = L.DomUtil.create('span', 'map-switcher-icon', container);
                icon.innerHTML = 'ğŸ—ºï¸';

                const select = L.DomUtil.create('select', 'map-switcher-select', container);
                
                // mapsDBì— ìˆëŠ” ëª¨ë“  ë§µì„ ì˜µì…˜ìœ¼ë¡œ ë§Œë“¦
                for (const [key, val] of Object.entries(mapsDB)) {
                    const option = document.createElement('option');
                    option.value = key; // qinghe, kaifeng ...
                    option.innerText = val.name; // ì²­í•˜, ê°œë´‰ ...
                    
                    // í˜„ì¬ ë³´ê³  ìˆëŠ” ë§µì´ë©´ ì„ íƒ ì²˜ë¦¬
                    if (key === currentMapId) option.selected = true;
                    select.appendChild(option);
                }

                // ë³€ê²½ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (íŒŒë¼ë¯¸í„° ë³€ê²½)
                select.onchange = function() {
                    // ?id=kaifeng í˜•íƒœë¡œ ì£¼ì†Œ ì´ë™
                    window.location.search = `?id=${this.value}`;
                };

                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });
        map.addControl(new MapSwitcherControl());


        // ==========================================
        // 5. ê¸°ëŠ¥ ë¡œì§ (ì „ì²´í™”ë©´, ë°ì´í„° ë¡œë”©)
        // ==========================================
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => alert(`ì˜¤ë¥˜: ${err.message}`));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // í˜„ì¬ ì„ íƒëœ ë§µì˜ JSON ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        fetch(currentConfig.json)
            .then(res => res.json())
            .then(data => createMarkers(data))
            .catch(err => {
                console.error(err);
                // ë°ì´í„° íŒŒì¼ì´ ì—†ì„ ë•Œ ì¡°ìš©íˆ ë„˜ì–´ê°€ê±°ë‚˜ ì•Œë¦¼
                if(currentMapId !== 'kaifeng') { // ê°œë´‰ì€ ì•„ì§ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì˜ˆì™¸ ì²˜ë¦¬ ì˜ˆì‹œ
                    alert(`ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${currentConfig.json}`);
                }
            });

        function createMarkers(data) {
            const layerGroups = {};
            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ë„ ë§µ IDë³„ë¡œ ë¶„ë¦¬í•´ì„œ ê´€ë¦¬ (ì²­í•˜ ì™„ë£Œë‘ ê°œë´‰ ì™„ë£Œê°€ ì„ì´ì§€ ì•Šê²Œ)
            const storageKey = `completed_${currentMapId}`; 
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];

            data.forEach(item => {
                if (!layerGroups[item.type]) layerGroups[item.type] = L.layerGroup();
                const imgName = typeMapping[item.type] || item.type;
                const isCompleted = completedList.includes(item.id);

                const myIcon = L.icon({
                    iconUrl: `../images/${imgName}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], 
                    popupAnchor: [0, -config.iconSize[1]],
                    className: isCompleted ? 'marker-completed' : ''
                });

                const marker = L.marker([item.y, item.x], { icon: myIcon });
                allMarkers[item.id] = marker;
                marker.bindPopup(() => generatePopupContent(item, storageKey));
                layerGroups[item.type].addLayer(marker);
            });

            for (const key in layerGroups) layerGroups[key].addTo(map);
            L.control.layers(null, layerGroups, { collapsed: false }).addTo(map);
        }

        function generatePopupContent(item, storageKey) {
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const isCompleted = completedList.includes(item.id);

            let html = `<div class="popup-container">
                <div class="popup-title">${item.name}</div>
                <div class="popup-type">â—ˆ ${item.type} â—ˆ</div>`;

            if (item.desc) html += `<div class="popup-desc">${item.desc}</div>`;

            html += `<div class="btn-container">`;
            if (item.link) html += `<a href="${item.link}" target="_blank" class="action-btn btn-wiki">ì§€ì¹¨ì„œ</a>`;

            const btnText = isCompleted ? "ì·¨ì†Œ" : "ì™„ë£Œ";
            const btnClass = isCompleted ? "btn-undo" : "btn-complete";
            
            html += `<button onclick="toggleComplete(${item.id}, '${storageKey}')" class="action-btn ${btnClass}">${btnText}</button>`;
            html += `</div>`; 

            if (item.image) html += `<img src="${item.image}" class="popup-img">`;
            html += `</div>`;
            return html;
        }

        window.toggleComplete = function(id, storageKey) {
            let completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const index = completedList.indexOf(id);
            const marker = allMarkers[id];
            
            if (!marker) return;

            if (index > -1) {
                completedList.splice(index, 1);
                L.DomUtil.removeClass(marker._icon, 'marker-completed');
            } else {
                completedList.push(id);
                L.DomUtil.addClass(marker._icon, 'marker-completed');
            }
            localStorage.setItem(storageKey, JSON.stringify(completedList));
            marker.closePopup(); marker.openPopup();
        };

        // (ê°œë°œìš©) í´ë¦­ ì‹œ ì¢Œí‘œ ë”°ê¸°
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);

            const content = `
                <div class="input-group">
                    <h4 style="margin:0 0 10px 0; text-align:center; color:#a08040; border-bottom:1px solid #ddd; padding-bottom:5px;">ìƒˆ ìœ„ì¹˜ ê¸°ë¡</h4>
                    <label>ì´ë¦„</label> <input type="text" id="input_name">
                    <label>ì¢…ë¥˜</label> 
                    <select id="input_type">
                        <option value="ê²½ê³„ì„">ê²½ê³„ì„</option>
                        <option value="ìƒì">ìƒì</option>
                        <option value="ë§Œì‚¬ë¡">ë§Œì‚¬ë¡</option>
                        <option value="ë³´ìŠ¤">ë³´ìŠ¤</option>
                    </select>
                    <label>ì„¤ëª…</label> <textarea id="input_desc" style="height:40px;"></textarea>
                    <label>ë§í¬</label> <input type="text" id="input_link">
                    <label>ì‚¬ì§„</label> <input type="text" id="input_image">
                    <button class="copy-btn" onclick="copyMarkerJson(${y}, ${x})">JSON ë³µì‚¬</button>
                </div>
            `;
            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
            setTimeout(() => document.getElementById('input_name')?.focus(), 100);
        });

        window.copyMarkerJson = function(y, x) {
            const name = document.getElementById('input_name').value || "ì´ë¦„ ì—†ìŒ";
            const type = document.getElementById('input_type').value;
            const desc = document.getElementById('input_desc').value;
            const link = document.getElementById('input_link').value;
            const image = document.getElementById('input_image').value;
            const uniqueId = Date.now(); 

            const jsonString = `,
  {
    "id": ${uniqueId},
    "name": "${name}",
    "type": "${type}",
    "y": ${y},
    "x": ${x},
    "desc": "${desc}",
    "link": "${link}",
    "image": "${image}"
  }`;
            copyToClipboard(jsonString);
        };

        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ ì™„ë£Œ!")).catch(() => fallbackCopy(text));
            } else { fallbackCopy(text); }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0";
            document.body.appendChild(ta); ta.focus(); ta.select();
            try { document.execCommand('copy') ? alert("ë³µì‚¬ ì™„ë£Œ!") : prompt("ë³µì‚¬ ì‹¤íŒ¨:", text); } 
            catch (err) { prompt("ì˜¤ë¥˜:", text); }
            document.body.removeChild(ta);
        }
    </script>
</body>
</html>
