<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Map테스트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* 기본 스타일 */
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; background: #1a1a1a; }
        
        /* 팝업 스타일 */
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 15px; width: 220px !important; }
        
        .popup-container { text-align: center; }
        .popup-title { font-size: 1.1em; font-weight: bold; margin: 5px 0; color: #333; }
        .popup-type { font-size: 0.8em; color: #666; margin-bottom: 8px; font-weight: bold; }
        .popup-desc { font-size: 0.95em; color: #444; margin: 8px 0; line-height: 1.4; text-align: left; background: #f9f9f9; padding: 5px; border-radius: 4px; }
        .popup-img { width: 100%; height: auto; border-radius: 4px; margin-top: 8px; display: block; border: 1px solid #ddd; }

        /* ★ 버튼 컨테이너 (Flexbox로 좌우 배치) */
        .btn-container {
            display: flex;
            gap: 5px; /* 버튼 사이 간격 */
            margin-top: 10px;
        }

        /* 공통 버튼 스타일 */
        .action-btn {
            flex: 1; /* 공간을 균등하게 차지 */
            padding: 8px 0;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            color: white;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        /* 위키 버튼 색상 */
        .btn-wiki { background-color: #5c6bc0; }
        .btn-wiki:hover { background-color: #3f51b5; }

        /* 완료 버튼 색상 (기본) */
        .btn-complete { background-color: #4CAF50; }
        .btn-complete:hover { background-color: #43a047; }

        /* 완료 취소 버튼 색상 (이미 완료된 경우) */
        .btn-undo { background-color: #757575; }

        /* ★ 완료된 마커 스타일 (흑백 + 투명도) */
        .marker-completed {
            filter: grayscale(100%);
            opacity: 0.5;
            transition: all 0.3s ease; /* 부드럽게 변함 */
        }


        /* 개발자용 입력 폼 스타일 */
        .input-group { text-align: left; min-width: 240px; }
        .input-group label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; color: #333; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; box-sizing: border-box; margin-bottom: 2px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;
        }
        .copy-btn {
            width: 100%; background: #2196F3; color: white; border: none; 
            padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 15px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. 기본 설정
        // ==========================================
        const config = {
            imageUrl: 'qinghe.jpg',       
            imageWidth: 7306,
            imageHeight: 4732,
            iconSize: [24, 24],
            jsonPath: 'json/data.json'
        };

        const typeMapping = {
            "경계석": "stone",
            "상자": "chest",
            "보스": "boss"
        };
        
        // 전역 변수로 마커들을 관리 (ID로 찾아서 스타일 바꾸기 위함)
        const allMarkers = {};


        // ==========================================
        // 2. 지도 초기화
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 2,
            zoomSnap: 0.5,
            zoomDelta: 0.5
        });

        const bounds = [[0, 0], [config.imageHeight, config.imageWidth]];
        L.imageOverlay(config.imageUrl, bounds).addTo(map);

        var centerY = config.imageHeight / 2;
        var centerX = config.imageWidth / 2;
        var initialZoom = -2.5; 
        map.setView([centerY, centerX], initialZoom);


        // ==========================================
        // 3. 데이터 로딩
        // ==========================================
        fetch(config.jsonPath)
            .then(res => res.json())
            .then(data => createMarkers(data))
            .catch(err => {
                console.error(err);
                alert('데이터 로딩 실패! Live Server를 확인하세요.');
            });


        // ==========================================
        // 4. 마커 생성 로직 (완료 기능 추가됨)
        // ==========================================
        function createMarkers(data) {
            const layerGroups = {};

            // 1. 로컬스토리지에서 완료된 목록 가져오기 (없으면 빈 배열)
            const completedList = JSON.parse(localStorage.getItem('completedMarkers')) || [];

            data.forEach(item => {
                if (!layerGroups[item.type]) {
                    layerGroups[item.type] = L.layerGroup();
                }

                const imgName = typeMapping[item.type] || item.type;
                
                // 완료 여부 확인
                const isCompleted = completedList.includes(item.id);

                // 아이콘 설정 (완료되었으면 클래스 추가)
                const myIcon = L.icon({
                    iconUrl: `images/${imgName}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], 
                    popupAnchor: [0, -config.iconSize[1]],
                    // ★ 핵심: 완료된 경우 'marker-completed' 클래스를 붙여서 흑백 처리
                    className: isCompleted ? 'marker-completed' : ''
                });

                const marker = L.marker([item.y, item.x], { icon: myIcon });

                // 전역 변수에 저장 (나중에 ID로 찾기 위해)
                allMarkers[item.id] = marker;

                // --- 팝업 HTML 생성 ---
                marker.bindPopup(() => generatePopupContent(item));

                layerGroups[item.type].addLayer(marker);
            });

            for (const key in layerGroups) {
                layerGroups[key].addTo(map); 
            }
            L.control.layers(null, layerGroups, { collapsed: false }).addTo(map);
        }

        // 팝업 내용 생성 함수 (상태에 따라 버튼 모양이 바뀜)
        function generatePopupContent(item) {
            const completedList = JSON.parse(localStorage.getItem('completedMarkers')) || [];
            const isCompleted = completedList.includes(item.id);

            let html = `<div class="popup-container">
                <div class="popup-title">${item.name}</div>
                <div class="popup-type">${item.type}</div>`;

            if (item.desc && item.desc.trim() !== "") {
                html += `<div class="popup-desc">${item.desc}</div>`;
            }

            // --- 버튼 영역 시작 ---
            html += `<div class="btn-container">`;

            // 1) 위키 링크 버튼 (링크가 있을 때만 생성)
            if (item.link && item.link.trim() !== "") {
                html += `<a href="${item.link}" target="_blank" class="action-btn btn-wiki">
                    위키
                </a>`;
            }

            // 2) 완료/취소 버튼
            // 토글 함수 호출 (ID 전달)
            const btnText = isCompleted ? "취소" : "완료";
            const btnClass = isCompleted ? "btn-undo" : "btn-complete";
            
            html += `<button onclick="toggleComplete(${item.id})" class="action-btn ${btnClass}">
                ${btnText}
            </button>`;

            html += `</div>`; // btn-container 끝
            // --- 버튼 영역 끝 ---

            if (item.image && item.image.trim() !== "") {
                html += `<img src="${item.image}" class="popup-img">`;
            }
            html += `</div>`;

            return html;
        }


        // ==========================================
        // 5. ★ 완료 상태 토글 함수 (전역)
        // ==========================================
        window.toggleComplete = function(id) {
            // 1. 현재 저장된 목록 불러오기
            let completedList = JSON.parse(localStorage.getItem('completedMarkers')) || [];
            const index = completedList.indexOf(id);

            const marker = allMarkers[id];
            if (!marker) return;

            // 2. 상태 변경 로직
            if (index > -1) {
                // 이미 완료됨 -> 취소 (목록에서 제거)
                completedList.splice(index, 1);
                // 흑백 스타일 제거
                L.DomUtil.removeClass(marker._icon, 'marker-completed');
            } else {
                // 완료 안 됨 -> 추가
                completedList.push(id);
                // 흑백 스타일 추가
                L.DomUtil.addClass(marker._icon, 'marker-completed');
            }

            // 3. 로컬스토리지에 저장
            localStorage.setItem('completedMarkers', JSON.stringify(completedList));

            // 4. 팝업 내용 새로고침 (버튼 텍스트 변경을 위해)
            // 현재 열려있는 팝업을 닫았다가 다시 열거나, 내용을 갱신
            marker.closePopup();
            marker.openPopup();
        };


        // ==========================================
        // 6. 입력 도구 (기존과 동일)
        // ==========================================
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);

            const content = `
                <div class="input-group">
                    <h4 style="margin:0 0 10px 0; text-align:center;">새 마커 추가</h4>
                    <label>이름:</label> <input type="text" id="input_name">
                    <label>타입:</label> 
                    <select id="input_type">
                        <option value="경계석">경계석</option>
                        <option value="상자">상자</option>
                        <option value="보스">보스</option>
                    </select>
                    <label>설명:</label> <textarea id="input_desc" style="height:40px;"></textarea>
                    <label>위키 링크:</label> <input type="text" id="input_link">
                    <label>이미지:</label> <input type="text" id="input_image">
                    <button class="copy-btn" onclick="copyMarkerJson(${y}, ${x})">JSON 복사하기</button>
                </div>
            `;
            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
            setTimeout(() => document.getElementById('input_name')?.focus(), 100);
        });

        window.copyMarkerJson = function(y, x) {
            const name = document.getElementById('input_name').value || "이름 없음";
            const type = document.getElementById('input_type').value;
            const desc = document.getElementById('input_desc').value;
            const link = document.getElementById('input_link').value;
            const image = document.getElementById('input_image').value;
            const uniqueId = Date.now(); 

            const jsonString = `
  {
    "id": ${uniqueId},
    "name": "${name}",
    "type": "${type}",
    "y": ${y},
    "x": ${x},
    "desc": "${desc}",
    "link": "${link}",
    "image": "${image}"
  },`;
            copyToClipboard(jsonString);
        };

        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert("복사 완료!")).catch(() => fallbackCopy(text));
            } else { fallbackCopy(text); }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0";
            document.body.appendChild(ta); ta.focus(); ta.select();
            try { document.execCommand('copy') ? alert("복사 완료!") : prompt("복사 실패:", text); } 
            catch (err) { prompt("오류:", text); }
            document.body.removeChild(ta);
        }
    </script>
</body>
</html>
