<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>인터렉티브 맵 프로젝트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* 화면 전체를 지도로 꽉 채우기 */
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; background: #1a1a1a; }
        
        /* 팝업 스타일 커스텀 */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .popup-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .popup-type { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .popup-desc { font-size: 0.95em; color: #333; }
        
        /* 좌표 복사 버튼 스타일 */
        .copy-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .copy-btn:active { background-color: #45a049; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. 기본 설정 (이 부분만 수정하면 됩니다)
        // ==========================================
        const config = {
            imageUrl: 'qinghe.jpg',  // 지도 이미지 파일명
            imageWidth: 2795,             // 이미지 실제 가로 크기 (픽셀)
            imageHeight: 1600,            // 이미지 실제 세로 크기 (픽셀)
            iconSize: [24, 24],           // 아이콘 크기 [가로, 세로]
            jsonPath: 'json/data.json'    // 데이터 파일 경로
        };

        // ==========================================
        // 2. 지도 초기화 (이미지 오버레이 방식)
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,            // 평면 좌표계 사용
            minZoom: -2,                  // 축소 허용 범위
            maxZoom: 2,                   // 확대 허용 범위
            zoomSnap: 0.5,                // 줌 단계를 부드럽게
            zoomDelta: 0.5
        });

        // 이미지 경계 설정
        const bounds = [[0, 0], [config.imageHeight, config.imageWidth]];
        
        // 이미지 불러오기
        L.imageOverlay(config.imageUrl, bounds).addTo(map);
        
        // 처음에 전체 지도가 보이도록 맞춤
        // 2. 원하는 위치와 줌 레벨을 직접 지정합니다.
// map.setView([세로중앙, 가로중앙], 줌레벨);
        // ==========================================
        // [수정된 부분] 세로 사이즈 맞춤 로직
        // ==========================================
        
        // 1. 현재 화면의 높이와 이미지의 높이 비율을 계산
        var mapHeight = map.getSize().y;       // 현재 지도(화면)의 세로 픽셀 수
        var imgHeight = config.imageHeight;    // 이미지 원본의 세로 픽셀 수
        
        // 비율 계산 (예: 화면이 1000px, 이미지가 2000px이면 비율은 0.5)
        var ratio = mapHeight / imgHeight;

        // 2. 그 비율에 맞는 줌 레벨을 Leaflet이 계산하도록 함
        // (두 번째 인자 0은 기준 줌 레벨입니다)
        var targetZoom = map.getScaleZoom(ratio, 0);

        // 3. 이미지의 정중앙을 그 줌 레벨로 바라보게 설정
        var centerY = config.imageHeight / 2;
        var centerX = config.imageWidth / 2;
        
        map.setView([centerY, centerX], targetZoom);

        // (선택사항) 창 크기가 바뀔 때마다 계속 세로를 맞추고 싶으면 아래 주석 해제
        /*
        map.on('resize', function() {
            var newRatio = map.getSize().y / config.imageHeight;
            var newZoom = map.getScaleZoom(newRatio, 0);
            map.setZoom(newZoom);
        });
        */



        // ==========================================
        // 3. JSON 데이터 불러오기 및 마커 생성
        // ==========================================
        fetch(config.jsonPath)
            .then(response => {
                if (!response.ok) throw new Error("JSON 파일을 찾을 수 없습니다.");
                return response.json();
            })
            .then(data => {
                createMarkers(data);
            })
            .catch(error => {
                console.error('에러:', error);
                alert('데이터 로딩 실패! (VS Code의 Live Server로 실행했는지 확인하세요)');
            });


        // ==========================================
        // 4. 마커 생성 및 필터 그룹화 함수
        // ==========================================
        function createMarkers(data) {
            const layerGroups = {};

            data.forEach(item => {
                // 해당 타입의 그룹이 없으면 생성
                if (!layerGroups[item.type]) {
                    layerGroups[item.type] = L.layerGroup();
                }

                // 아이콘 설정 (파일명 = type.png)
                const myIcon = L.icon({
                    iconUrl: `images/${item.type}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], // 아이콘 하단 중앙이 좌표
                    popupAnchor: [0, -config.iconSize[1]]
                });

                // 마커 생성
                const marker = L.marker([item.y, item.x], { icon: myIcon });

                // 팝업 내용 (HTML)
                const popupContent = `
                    <div style="text-align:center">
                        <div class="popup-title">${item.name}</div>
                        <div class="popup-type">${item.type}</div>
                        <div class="popup-desc">${item.desc || ''}</div>
                    </div>
                `;
                marker.bindPopup(popupContent);

                // 그룹에 추가
                layerGroups[item.type].addLayer(marker);
            });

            // 필터 컨트롤 (우측 상단 메뉴) 생성
            const overlays = {};
            const typeNames = { // 화면에 표시될 한글 이름 매핑
                "stone": "경계석",
                "chest": "보물상자",
                "boss": "보스 몬스터"
            };

            for (const [type, layer] of Object.entries(layerGroups)) {
                layer.addTo(map); // 기본적으로 모두 켜기
                const label = typeNames[type] || type; // 한글 이름 없으면 영어 그대로
                overlays[label] = layer;
            }

            L.control.layers(null, overlays, { collapsed: false }).addTo(map);
        }


        // ==========================================
        // 5. (개발용) 클릭/터치 시 좌표 복사 기능
        // ==========================================
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);
            
            // JSON에 바로 붙여넣을 수 있는 포맷
            const copyText = `"y": ${y}, "x": ${x}`;

            const content = `
                <div style="text-align:center; min-width: 160px;">
                    <div style="font-weight:bold; margin-bottom:5px;">좌표 확인</div>
                    <div style="background:#f1f1f1; padding:5px; font-family:monospace; margin-bottom:5px;">
                        y: ${y}, x: ${x}
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('${copyText}')">
                        좌표 복사하기
                    </button>
                </div>
            `;

            L.popup()
                .setLatLng(e.latlng)
                .setContent(content)
                .openOn(map);
        });

                // ==========================================
        // [수정됨] 강력한 복사 기능 (모바일 호환성 강화)
        // ==========================================
        window.copyToClipboard = function(text) {
            // 1. 최신 방식 시도 (HTTPS 환경)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alert("복사되었습니다: " + text);
                    })
                    .catch(err => {
                        // 실패하면 옛날 방식 시도
                        fallbackCopy(text);
                    });
            } else {
                // 최신 방식 지원 안 하면 바로 옛날 방식 시도
                fallbackCopy(text);
            }
        };

        // 옛날 방식 (화면에 안 보이는 글상자를 만들어서 복사)
        function fallbackCopy(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            
            // 화면 밖으로 튀지 않게 설정
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                if (successful) {
                    alert("복사되었습니다: " + text);
                } else {
                    // 진짜 모든 게 다 실패했을 때 최후의 수단
                    prompt("복사가 차단되었습니다. 아래 텍스트를 직접 복사하세요:", text);
                }
            } catch (err) {
                prompt("복사가 차단되었습니다. 아래 텍스트를 직접 복사하세요:", text);
            }

            document.body.removeChild(textArea);
        }


    </script>
</body>
</html>
