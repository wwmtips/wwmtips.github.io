<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>인터렉티브 맵 (한글 버전)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; background: #1a1a1a; }
        .popup-img { width: 100%; height: auto; border-radius: 4px; margin-top: 8px; display: block; }
    </style>
</head>
<body>

    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. 설정 및 한글-이미지 연결
        // ==========================================
        const config = {
            imageUrl: 'qinghe.jpg',       // 지도 이미지
            imageWidth: 7306,
            imageHeight: 4732,
            iconSize: [24, 24],
            jsonPath: 'json/data.json'
        };

        // ★ 여기서 '한글 타입'과 '영어 이미지 파일명'을 연결합니다.
        // (데이터는 한글로 쓰되, 파일명은 안전하게 영어를 쓰는 게 좋습니다)
        const typeMapping = {
            "경계석": "stone",   // 타입이 '경계석'이면 images/stone.png 사용
            "상자": "chest",     // 타입이 '상자'면 images/chest.png 사용
            "보스": "boss"       // 타입이 '보스'면 images/boss.png 사용
        };


        // ==========================================
        // 2. 지도 생성
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 2,
            zoomSnap: 0.5,
            zoomDelta: 0.5
        });

        const bounds = [[0, 0], [config.imageHeight, config.imageWidth]];
        L.imageOverlay(config.imageUrl, bounds).addTo(map);

        var centerY = config.imageHeight / 2;
        var centerX = config.imageWidth / 2;
        map.setView([centerY, centerX], -0.5);


        // ==========================================
        // 3. 데이터 로딩
        // ==========================================
        fetch(config.jsonPath)
            .then(res => res.json())
            .then(data => createMarkers(data))
            .catch(err => {
                console.error(err);
                alert('데이터 로딩 실패! Live Server 사용 중인지 확인하세요.');
            });


        // ==========================================
        // 4. 마커 생성 (한글 타입 지원)
        // ==========================================
        function createMarkers(data) {
            const layerGroups = {};

            data.forEach(item => {
                // 1. 그룹 생성 (한글 이름 그대로 사용)
                if (!layerGroups[item.type]) {
                    layerGroups[item.type] = L.layerGroup();
                }

                // 2. 이미지 파일명 찾기 (매핑된 게 있으면 그거 쓰고, 없으면 그냥 타입 이름 그대로)
                // 예: "경계석" -> "stone" -> "images/stone.png"
                const imgName = typeMapping[item.type] || item.type;
                
                const myIcon = L.icon({
                    iconUrl: `images/${imgName}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]],
                    popupAnchor: [0, -config.iconSize[1]]
                });

                // 3. 마커 생성
                const marker = L.marker([item.y, item.x], { icon: myIcon });

                // 4. 팝업 내용
                let popupHtml = `<div style="text-align:center; min-width:150px">
                    <h3 style="margin:5px 0">${item.name}</h3>
                    <p style="margin:0; color:gray; font-size:0.8em; margin-bottom:5px;">${item.type}</p>`;

                if (item.desc) popupHtml += `<p style="margin:5px 0; font-size:0.95em; color:#333;">${item.desc}</p>`;
                if (item.image) popupHtml += `<img src="${item.image}" class="popup-img">`;
                
                popupHtml += `</div>`;

                marker.bindPopup(popupHtml);
                layerGroups[item.type].addLayer(marker);
            });

            // 필터 컨트롤 (이제 한글 그대로 표시됨)
            L.control.layers(null, layerGroups, { collapsed: false }).addTo(map);
        }


        // ==========================================
        // 5. 입력 도구 (한글 선택지)
        // ==========================================
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);

            // ★ 입력창의 선택지도 한글로 변경했습니다.
            const content = `
                <div style="min-width:220px; text-align:left;">
                    <h4 style="margin:0 0 10px 0; text-align:center;">새 마커 추가</h4>
                    
                    <label>이름:</label>
                    <input type="text" id="input_name" style="width:100%; margin-bottom:5px;">
                    
                    <label>타입:</label>
                    <select id="input_type" style="width:100%; margin-bottom:5px; padding:5px;">
                        <option value="경계석">경계석</option>
                        <option value="상자">상자</option>
                        <option value="보스">보스</option>
                    </select>

                    <label>설명:</label>
                    <textarea id="input_desc" style="width:100%; height:30px; margin-bottom:5px;"></textarea>

                    <label>이미지 경로:</label>
                    <input type="text" id="input_image" style="width:100%; margin-bottom:10px;">

                    <button onclick="copyMarkerJson(${y}, ${x})" 
                        style="width:100%; background:#2196F3; color:white; border:none; padding:10px; border-radius:4px; font-weight:bold;">
                        JSON 복사하기
                    </button>
                </div>
            `;

            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
            setTimeout(() => document.getElementById('input_name')?.focus(), 100);
        });

        window.copyMarkerJson = function(y, x) {
            const name = document.getElementById('input_name').value || "이름 없음";
            const type = document.getElementById('input_type').value; // 이제 "경계석" 같은 한글이 들어감
            const desc = document.getElementById('input_desc').value;
            const image = document.getElementById('input_image').value;
            const uniqueId = Date.now(); 

            // JSON 생성
            const jsonString = `,
  {
    "id": ${uniqueId},
    "name": "${name}",
    "type": "${type}", 
    "y": ${y},
    "x": ${x},
    "desc": "${desc}",
    "image": "${image}"
  }`;
            copyToClipboard(jsonString);
        };

        // 복사 함수
        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("복사 완료!"))
                    .catch(() => fallbackCopy(text));
            } else { fallbackCopy(text); }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            try {
                if(document.execCommand('copy')) alert("복사 완료!");
                else prompt("복사 실패. 직접 복사하세요:", text);
            } catch (err) { prompt("오류. 직접 복사하세요:", text); }
            document.body.removeChild(ta);
        }
    </script>
</body>
</html>
