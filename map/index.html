<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Where Winds Meet - Interactive Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; background: #1a1a1a; }
        
        /* íŒì—… ìŠ¤íƒ€ì¼ */
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 15px; width: 200px !important; }
        
        .popup-container { text-align: center; }
        .popup-title { font-size: 1.1em; font-weight: bold; margin: 5px 0; color: #333; }
        .popup-type { font-size: 0.8em; color: #666; margin-bottom: 8px; font-weight: bold; }
        .popup-desc { font-size: 0.95em; color: #444; margin: 8px 0; line-height: 1.4; text-align: left; background: #f9f9f9; padding: 5px; border-radius: 4px; }
        .popup-img { width: 100%; height: auto; border-radius: 4px; margin-top: 8px; display: block; border: 1px solid #ddd; }

        /* ë§í¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .popup-link-btn {
            display: block;
            margin-top: 10px;
            padding: 8px 0;
            background-color: #5c6bc0; /* ë²„íŠ¼ ìƒ‰ìƒ */
            color: white !important;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            transition: background 0.2s;
        }
        .popup-link-btn:hover { background-color: #3f51b5; }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-group { text-align: left; min-width: 240px; }
        .input-group label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; color: #333; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; box-sizing: border-box; margin-bottom: 2px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;
        }
        .copy-btn {
            width: 100%; background: #2196F3; color: white; border: none; 
            padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 15px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. ê¸°ë³¸ ì„¤ì •
        // ==========================================
        const config = {
            imageUrl: 'qinghe.jpg',       // ì§€ë„ ì´ë¯¸ì§€ íŒŒì¼ëª…
            imageWidth: 7306,
            imageHeight: 4732,
            iconSize: [24, 24],
            jsonPath: 'json/data.json'
        };

        const typeMapping = {
            "ê²½ê³„ì„": "stone",
            "ìƒì": "chest",
            "ë³´ìŠ¤": "boss"
        };


        // ==========================================
        // 2. ì§€ë„ ì´ˆê¸°í™”
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 2,
            zoomSnap: 0.5,
            zoomDelta: 0.5
        });

        const bounds = [[0, 0], [config.imageHeight, config.imageWidth]];
        L.imageOverlay(config.imageUrl, bounds).addTo(map);

        // ì´ˆê¸° í™”ë©´ ì„¤ì • (ì¶•ì†Œ)
        var centerY = config.imageHeight / 2;
        var centerX = config.imageWidth / 2;
        var initialZoom = -2; 
        map.setView([centerY, centerX], initialZoom);


        // ==========================================
        // 3. ë°ì´í„° ë¡œë”©
        // ==========================================
        fetch(config.jsonPath)
            .then(res => res.json())
            .then(data => createMarkers(data))
            .catch(err => {
                console.error(err);
                alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨! (Live Server í™•ì¸)');
            });


        // ==========================================
        // 4. ë§ˆì»¤ ìƒì„± ë¡œì§ (ë§í¬ ë²„íŠ¼ ì¶”ê°€ë¨)
        // ==========================================
        function createMarkers(data) {
            const layerGroups = {};

            data.forEach(item => {
                // ê·¸ë£¹ ìƒì„±
                if (!layerGroups[item.type]) {
                    layerGroups[item.type] = L.layerGroup();
                }

                // ì•„ì´ì½˜ ì„¤ì •
                const imgName = typeMapping[item.type] || item.type;
                const myIcon = L.icon({
                    iconUrl: `images/${imgName}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], 
                    popupAnchor: [0, -config.iconSize[1]]
                });

                // ë§ˆì»¤ ìƒì„±
                const marker = L.marker([item.y, item.x], { icon: myIcon });

                // --- íŒì—… ë‚´ìš© êµ¬ì„± ---
                let popupHtml = `<div class="popup-container">
                    <div class="popup-title">${item.name}</div>
                    <div class="popup-type">${item.type}</div>`;

                if (item.desc && item.desc.trim() !== "") {
                    popupHtml += `<div class="popup-desc">${item.desc}</div>`;
                }

                // â˜… ë§í¬ ë²„íŠ¼ ìƒì„± ë¡œì§ (ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ)
                if (item.link && item.link.trim() !== "") {
                    popupHtml += `<a href="${item.link}" target="_blank" class="popup-link-btn">
                        ìœ„í‚¤ / ê³µëµ ë³´ê¸° ğŸ”—
                    </a>`;
                }

                if (item.image && item.image.trim() !== "") {
                    popupHtml += `<img src="${item.image}" class="popup-img">`;
                }
                popupHtml += `</div>`;
                // ---------------------

                marker.bindPopup(popupHtml);
                layerGroups[item.type].addLayer(marker);
            });

            // ëª¨ë“  í•„í„° ì¼œê¸°
            for (const key in layerGroups) {
                layerGroups[key].addTo(map); 
            }

            L.control.layers(null, layerGroups, { collapsed: false }).addTo(map);
        }


        // ==========================================
        // 5. ì…ë ¥ ë„êµ¬ (ë§í¬ ì…ë ¥ë€ ì¶”ê°€ë¨)
        // ==========================================
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);

            const content = `
                <div class="input-group">
                    <h4 style="margin:0 0 10px 0; text-align:center;">ìƒˆ ë§ˆì»¤ ì¶”ê°€</h4>
                    
                    <label>ì´ë¦„:</label>
                    <input type="text" id="input_name" placeholder="ì´ë¦„ ì…ë ¥">
                    
                    <label>íƒ€ì…:</label>
                    <select id="input_type">
                        <option value="ê²½ê³„ì„">ê²½ê³„ì„</option>
                        <option value="ìƒì">ìƒì</option>
                        <option value="ë³´ìŠ¤">ë³´ìŠ¤</option>
                    </select>

                    <label>ì„¤ëª… (ì„ íƒ):</label>
                    <textarea id="input_desc" style="height:40px;" placeholder="ì„¤ëª… ì…ë ¥"></textarea>

                    <label>ìœ„í‚¤ ë§í¬ (ì„ íƒ):</label>
                    <input type="text" id="input_link" placeholder="https://...">

                    <label>ì´ë¯¸ì§€ ê²½ë¡œ (ì„ íƒ):</label>
                    <input type="text" id="input_image" placeholder="ì˜ˆ: images/1.jpg">

                    <button class="copy-btn" onclick="copyMarkerJson(${y}, ${x})">
                        JSON ë³µì‚¬í•˜ê¸°
                    </button>
                </div>
            `;

            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
            setTimeout(() => document.getElementById('input_name')?.focus(), 100);
        });

        // JSON ìƒì„± ë° ë³µì‚¬
        window.copyMarkerJson = function(y, x) {
            const name = document.getElementById('input_name').value || "ì´ë¦„ ì—†ìŒ";
            const type = document.getElementById('input_type').value;
            const desc = document.getElementById('input_desc').value;
            const link = document.getElementById('input_link').value;   // ë§í¬ ê°’ ê°€ì ¸ì˜¤ê¸°
            const image = document.getElementById('input_image').value;
            const uniqueId = Date.now(); 

            // JSON í¬ë§· (link í•„ë“œ ì¶”ê°€ë¨)
            const jsonString = `,
  {
    "id": ${uniqueId},
    "name": "${name}",
    "type": "${type}",
    "y": ${y},
    "x": ${x},
    "desc": "${desc}",
    "link": "${link}",
    "image": "${image}"
  }`;
            copyToClipboard(jsonString);
        };

        // ë³µì‚¬ ê¸°ëŠ¥
        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("ë³µì‚¬ ì™„ë£Œ! data.json ë’¤ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."))
                    .catch(() => fallbackCopy(text));
            } else { fallbackCopy(text); }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            try {
                if(document.execCommand('copy')) alert("ë³µì‚¬ ì™„ë£Œ!");
                else prompt("ë³µì‚¬ ì‹¤íŒ¨. ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”:", text);
            } catch (err) { prompt("ì˜¤ë¥˜:", text); }
            document.body.removeChild(ta);
        }
    </script>
</body>
</html>
