<!DOCTYPE html>
<html>
<head>
    <title>인터렉티브 맵 (JSON 연동)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body, #map { height: 100%; margin: 0; background: #222; }
        /* 마커 아이콘 크기 스타일 (필요시 수정) */
        .custom-icon { width: 32px; height: 32px; object-fit: contain; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // --- 1. 기본 설정 ---
        const config = {
            imageUrl: 'qinghe.jpg', // 지도 이미지 파일명
            imageWidth: 2479,            // 실제 이미지 가로 크기
            imageHeight: 1600,           // 실제 이미지 세로 크기
            iconSize: [16, 16],          // 마커 아이콘 크기 [가로, 세로]
            jsonPath: 'json/data.json'   // 데이터 파일 경로
        };

        // --- 2. 지도 생성 (오버레이 방식) ---
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 2,
            zoomSnap: 0.5
        });

        const bounds = [[0, 0], [config.imageHeight, config.imageWidth]];
        L.imageOverlay(config.imageUrl, bounds).addTo(map);
        map.fitBounds(bounds);


        // --- 3. 데이터 불러오기 및 마커 생성 ---
        fetch(config.jsonPath)
            .then(response => {
                if (!response.ok) throw new Error("JSON 파일을 찾을 수 없습니다.");
                return response.json();
            })
            .then(data => {
                createMarkers(data);
            })
            .catch(error => {
                console.error('에러 발생:', error);
                alert('데이터를 불러오는 데 실패했습니다. (서버 실행 여부를 확인하세요)');
            });


        // --- 4. 마커 생성 및 필터 그룹화 로직 ---
        function createMarkers(data) {
            // 그룹별로 마커를 담을 통(Object)을 만듭니다.
            const layerGroups = {};

            data.forEach(item => {
                // 1) 해당 타입의 그룹이 없으면 새로 만듭니다.
                if (!layerGroups[item.type]) {
                    layerGroups[item.type] = L.layerGroup();
                }

                // 2) 아이콘 설정 (type 이름에 따라 이미지 파일 자동 매칭)
                // 예: type이 'stone'이면 -> 'images/stone.png'
                const myIcon = L.icon({
                    iconUrl: `images/${item.type}.png`, 
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], // 아이콘의 하단 중앙이 좌표에 찍히도록
                    popupAnchor: [0, -config.iconSize[1]] // 팝업 위치 조절
                });

                // 3) 마커 생성
                const marker = L.marker([item.y, item.x], { icon: myIcon });
                
                // 4) 팝업 내용 구성 (HTML 태그 사용 가능)
                const popupContent = `
                    <div style="text-align:center">
                        <h3 style="margin:5px 0">${item.name}</h3>
                        <p style="margin:0; color:gray">${item.type}</p>
                        <br>
                        ${item.desc ? `<span>${item.desc}</span>` : ''}
                    </div>
                `;
                marker.bindPopup(popupContent);

                // 5) 그룹에 마커 추가
                layerGroups[item.type].addLayer(marker);
            });

            // --- 5. 필터 컨트롤 생성 (우측 상단 레이어 버튼) ---
            const overlays = {};
            
            // 한글 이름 매핑 (필요하면 여기서 이름을 예쁘게 바꾸세요)
            const typeNames = {
                "stone": "경계석",
                "chest": "보물상자",
                "boss": "보스 몬스터"
            };

            // 그룹들을 지도에 추가하고, 필터 메뉴에도 등록
            for (const [type, layer] of Object.entries(layerGroups)) {
                layer.addTo(map); // 처음에 모두 보이게 하기
                
                // 메뉴에 표시될 이름 (매핑된 이름이 있으면 쓰고, 없으면 영어 type 그대로)
                const labelName = typeNames[type] || type; 
                overlays[labelName] = layer;
            }

            // 우측 상단에 필터 버튼 추가
            L.control.layers(null, overlays, { collapsed: false }).addTo(map);
        }

        // --- 6. (개발용) 클릭 시 좌표 따기 ---
        map.on('click', function(e) {
            console.log(`"y": ${Math.round(e.latlng.lat)}, "x": ${Math.round(e.latlng.lng)}`);
        });

    </script>
</body>
</html>
