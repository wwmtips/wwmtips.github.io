<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>인터렉티브 맵 프로젝트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* 화면 전체를 지도로 꽉 채우기 */
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; background: #1a1a1a; }
        
        /* 팝업 스타일 커스텀 */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .popup-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .popup-type { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .popup-desc { font-size: 0.95em; color: #333; }
        
        /* 좌표 복사 버튼 스타일 */
        .copy-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .copy-btn:active { background-color: #45a049; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. 기본 설정 (이 부분만 수정하면 됩니다)
        // ==========================================
        const config = {
            imageUrl: 'qinghe.jpg',  // 지도 이미지 파일명
            imageWidth: 3795,             // 이미지 실제 가로 크기 (픽셀)
            imageHeight: 2400,            // 이미지 실제 세로 크기 (픽셀)
            iconSize: [16, 16],           // 아이콘 크기 [가로, 세로]
            jsonPath: 'json/data.json'    // 데이터 파일 경로
        };

        // ==========================================
        // 2. 지도 초기화 (이미지 오버레이 방식)
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,            // 평면 좌표계 사용
            minZoom: -2,                  // 축소 허용 범위
            maxZoom: 2,                   // 확대 허용 범위
            zoomSnap: 0.5,                // 줌 단계를 부드럽게
            zoomDelta: 0.5
        });

        // 이미지 경계 설정
        const bounds = [[0, 0], [config.imageHeight, config.imageWidth]];
        
        // 이미지 불러오기
        L.imageOverlay(config.imageUrl, bounds).addTo(map);
        
        // 처음에 전체 지도가 보이도록 맞춤
        map.fitBounds(bounds);


        // ==========================================
        // 3. JSON 데이터 불러오기 및 마커 생성
        // ==========================================
        fetch(config.jsonPath)
            .then(response => {
                if (!response.ok) throw new Error("JSON 파일을 찾을 수 없습니다.");
                return response.json();
            })
            .then(data => {
                createMarkers(data);
            })
            .catch(error => {
                console.error('에러:', error);
                alert('데이터 로딩 실패! (VS Code의 Live Server로 실행했는지 확인하세요)');
            });


        // ==========================================
        // 4. 마커 생성 및 필터 그룹화 함수
        // ==========================================
        function createMarkers(data) {
            const layerGroups = {};

            data.forEach(item => {
                // 해당 타입의 그룹이 없으면 생성
                if (!layerGroups[item.type]) {
                    layerGroups[item.type] = L.layerGroup();
                }

                // 아이콘 설정 (파일명 = type.png)
                const myIcon = L.icon({
                    iconUrl: `images/${item.type}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], // 아이콘 하단 중앙이 좌표
                    popupAnchor: [0, -config.iconSize[1]]
                });

                // 마커 생성
                const marker = L.marker([item.y, item.x], { icon: myIcon });

                // 팝업 내용 (HTML)
                const popupContent = `
                    <div style="text-align:center">
                        <div class="popup-title">${item.name}</div>
                        <div class="popup-type">${item.type}</div>
                        <div class="popup-desc">${item.desc || ''}</div>
                    </div>
                `;
                marker.bindPopup(popupContent);

                // 그룹에 추가
                layerGroups[item.type].addLayer(marker);
            });

            // 필터 컨트롤 (우측 상단 메뉴) 생성
            const overlays = {};
            const typeNames = { // 화면에 표시될 한글 이름 매핑
                "stone": "경계석",
                "chest": "보물상자",
                "boss": "보스 몬스터"
            };

            for (const [type, layer] of Object.entries(layerGroups)) {
                layer.addTo(map); // 기본적으로 모두 켜기
                const label = typeNames[type] || type; // 한글 이름 없으면 영어 그대로
                overlays[label] = layer;
            }

            L.control.layers(null, overlays, { collapsed: false }).addTo(map);
        }


        // ==========================================
        // 5. (개발용) 클릭/터치 시 좌표 복사 기능
        // ==========================================
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);
            
            // JSON에 바로 붙여넣을 수 있는 포맷
            const copyText = `"y": ${y}, "x": ${x}`;

            const content = `
                <div style="text-align:center; min-width: 160px;">
                    <div style="font-weight:bold; margin-bottom:5px;">좌표 확인</div>
                    <div style="background:#f1f1f1; padding:5px; font-family:monospace; margin-bottom:5px;">
                        y: ${y}, x: ${x}
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('${copyText}')">
                        좌표 복사하기
                    </button>
                </div>
            `;

            L.popup()
                .setLatLng(e.latlng)
                .setContent(content)
                .openOn(map);
        });

        // 클립보드 복사 함수 (전역 함수로 선언해야 onclick에서 실행됨)
        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('복사완료: ' + text);
                }).catch(err => {
                    prompt("복사가 차단되었습니다. 아래 텍스트를 직접 복사하세요:", text);
                });
            } else {
                // 구형 브라우저 등 호환성
                prompt("이 텍스트를 복사하세요:", text);
            }
        };

    </script>
</body>
</html>
