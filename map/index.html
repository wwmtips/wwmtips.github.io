<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ìš´ ëŒ€ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../map_style.css">
</head>
<body>

    <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
        <span>â˜°</span> í•„í„° & ê²€ìƒ‰
    </button>

    <div id="map-sidebar" class="map-sidebar">
        <div class="sidebar-close-btn" onclick="toggleSidebar()">âœ•</div>

        <div class="sidebar-header">
            <div class="search-wrapper">
                <input type="text" id="marker-search" class="sidebar-search-input" placeholder="ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ìƒì)">
                <span class="search-icon">ğŸ”</span>
            </div>
            <div class="filter-controls">
                <button class="filter-control-btn" onclick="setAllFilters(true)">ëª¨ë‘ í‘œì‹œ</button>
                <button class="filter-control-btn" onclick="setAllFilters(false)">ëª¨ë‘ ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>

        <div id="filter-list" class="filter-list-container">
            </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. ë§µ ë°ì´í„°ë² ì´ìŠ¤ (ì„¤ì •)
        // ==========================================
        const mapsDB = {
            "qinghe": {
                name: "ì²­í•˜",
                img: "../qinghe.jpg",       
                json: "../json/qinghe.json",
                w: 7306, h: 4732            
            },
            "kaifeng": {
                name: "ê°œë´‰",
                img: "../kaifeng.jpg",      
                json: "../json/kaifeng.json", 
                w: 8000, h: 6000            
            }
        };

        const typeMapping = {
            "ê²½ê³„ì„": "stone", "ìƒì": "chest", "ë§Œì‚¬ë¡": "ic_mansa", "ë³´ìŠ¤": "boss"
        };

        // ==========================================
        // 2. ì´ˆê¸°í™” ë° ì „ì—­ ë³€ìˆ˜
        // ==========================================
        const urlParams = new URLSearchParams(window.location.search);
        let currentMapId = urlParams.get('id');
        if (!currentMapId || !mapsDB[currentMapId]) currentMapId = "qinghe";
        const currentConfig = mapsDB[currentMapId];
        document.title = `${currentConfig.name} - ì—°ìš´ ì§€ë„`;

        const config = { iconSize: [30, 30] };
        
        // ë§ˆì»¤ ê´€ë¦¬ìš© ê°ì²´
        const layerGroups = {};  // íƒ€ì…ë³„ ê·¸ë£¹ (ì²´í¬ë°•ìŠ¤ìš©)
        const allMarkers = [];   // ê²€ìƒ‰ìš© ì „ì²´ ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸

        // ==========================================
        // 3. ì§€ë„ ìƒì„±
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 2,
            zoomSnap: 0.5,
            zoomDelta: 0.5,
            zoomControl: false,
            attributionControl: false 
        });

        const bounds = [[0, 0], [currentConfig.h, currentConfig.w]];
        L.imageOverlay(currentConfig.img, bounds).addTo(map);
        map.setView([currentConfig.h / 2, currentConfig.w / 2], -2.5);

        // ==========================================
        // 4. ì»¨íŠ¸ë¡¤ ë°°ì¹˜
        // ==========================================
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // ì „ì²´í™”ë©´ (ì¢Œì¸¡ í•˜ë‹¨)
        const FullscreenControl = L.Control.extend({
            options: { position: 'bottomleft' },
            onAdd: function () {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const btn = L.DomUtil.create('a', 'leaflet-control-fullscreen', container);
                btn.href = '#'; btn.innerHTML = 'â›¶'; btn.title = "ì „ì²´í™”ë©´";
                btn.onclick = (e) => { e.preventDefault(); toggleFullscreen(); };
                return container;
            }
        });
        map.addControl(new FullscreenControl());

        // ë§µ ë³€ê²½ ë©”ë‰´ (ìš°ì¸¡ ìƒë‹¨)
        const MapSwitcherControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function () {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control map-switcher-control');
                const icon = L.DomUtil.create('span', 'map-switcher-icon', container);
                icon.innerHTML = 'ğŸ—ºï¸';
                const select = L.DomUtil.create('select', 'map-switcher-select', container);
                for (const [key, val] of Object.entries(mapsDB)) {
                    const option = document.createElement('option');
                    option.value = key; 
                    option.innerText = val.name; 
                    if (key === currentMapId) option.selected = true;
                    select.appendChild(option);
                }
                select.onchange = function() { window.location.search = `?id=${this.value}`; };
                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });
        map.addControl(new MapSwitcherControl());


        // ==========================================
        // 5. ë°ì´í„° ë¡œë”© ë° ë§ˆì»¤ ìƒì„±
        // ==========================================
        fetch(currentConfig.json)
            .then(res => res.json())
            .then(data => {
                createMarkers(data);
                generateSidebar(data); // â˜… ì‚¬ì´ë“œë°” ëª©ë¡ ìƒì„±
            })
            .catch(err => {
                console.error(err);
                if(currentMapId !== 'kaifeng') alert(`ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${currentConfig.json}`);
            });

        function createMarkers(data) {
            const storageKey = `completed_${currentMapId}`; 
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];

            data.forEach(item => {
                // 1. ê·¸ë£¹ ìƒì„±
                if (!layerGroups[item.type]) {
                    layerGroups[item.type] = L.layerGroup();
                }

                // 2. ë§ˆì»¤ ìƒì„±
                const imgName = typeMapping[item.type] || item.type;
                const isCompleted = completedList.includes(item.id);

                const myIcon = L.icon({
                    iconUrl: `../images/${imgName}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], 
                    popupAnchor: [0, -config.iconSize[1]],
                    className: isCompleted ? 'marker-completed' : ''
                });

                const marker = L.marker([item.y, item.x], { icon: myIcon });
                
                // íŒì—… ì„¤ì •
                marker.bindPopup(() => generatePopupContent(item, storageKey, marker));

                // 3. ì €ì¥ì†Œì— ë“±ë¡
                layerGroups[item.type].addLayer(marker); // ê·¸ë£¹ìš©
                allMarkers.push({ data: item, marker: marker }); // ê²€ìƒ‰ìš©
            });

            // ì´ˆê¸° ìƒíƒœ: ëª¨ë“  ê·¸ë£¹ì„ ì§€ë„ì— í‘œì‹œ
            for (const key in layerGroups) {
                layerGroups[key].addTo(map);
            }
        }

        // ==========================================
        // 6. [NEW] ì‚¬ì´ë“œë°” ë° í•„í„° ë¡œì§
        // ==========================================
        
        // A. ì‚¬ì´ë“œë°” ëª©ë¡ ìƒì„± (ì¹´í…Œê³ ë¦¬ë³„)
        function generateSidebar(data) {
            const filterList = document.getElementById('filter-list');
            filterList.innerHTML = '';

            // íƒ€ì…ë³„ ê°œìˆ˜ ê³„ì‚°
            const counts = {};
            data.forEach(item => {
                counts[item.type] = (counts[item.type] || 0) + 1;
            });

            // DOM ìƒì„±
            for (const [type, count] of Object.entries(counts)) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'filter-item';
                
                // í´ë¦­ ì‹œ ì²´í¬ë°•ìŠ¤ í† ê¸€
                itemDiv.onclick = (e) => {
                    // ì²´í¬ë°•ìŠ¤ë¥¼ ì§ì ‘ ëˆ„ë¥¸ ê²Œ ì•„ë‹ˆë©´ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½
                    if(e.target.type !== 'checkbox') {
                        const checkbox = itemDiv.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        toggleLayer(type, checkbox.checked);
                    }
                };

                // ì•„ì´ì½˜ ì´ë¯¸ì§€
                const imgName = typeMapping[type] || type;
                
                itemDiv.innerHTML = `
                    <label class="filter-label" style="cursor:pointer;">
                        <input type="checkbox" class="filter-checkbox" checked onchange="toggleLayer('${type}', this.checked)">
                        <img src="../images/${imgName}.png" width="24" height="24" onerror="this.style.display='none'">
                        ${type}
                    </label>
                    <span class="filter-count">${count}</span>
                `;
                filterList.appendChild(itemDiv);
            }
        }

        // B. í•„í„° í† ê¸€ (ì²´í¬ë°•ìŠ¤)
        function toggleLayer(type, isChecked) {
            if (isChecked) {
                map.addLayer(layerGroups[type]);
            } else {
                map.removeLayer(layerGroups[type]);
            }
        }

        // C. ëª¨ë‘ í‘œì‹œ / ëª¨ë‘ ìˆ¨ê¸°ê¸°
        function setAllFilters(status) {
            const checkboxes = document.querySelectorAll('.filter-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = status;
                // ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ ëŒ€ì‹  ë¡œì§ ì§ì ‘ í˜¸ì¶œ
                const type = cb.closest('.filter-item').querySelector('.filter-label').textContent.trim();
                toggleLayer(type, status);
            });
        }

        // D. ê²€ìƒ‰ ê¸°ëŠ¥ (ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰)
        const searchInput = document.getElementById('marker-search');
        searchInput.addEventListener('input', function(e) {
            const keyword = e.target.value.trim();
            
            if (keyword === "") {
                // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì²´í¬ë°•ìŠ¤ ìƒíƒœëŒ€ë¡œ ë³µêµ¬
                const checkboxes = document.querySelectorAll('.filter-checkbox');
                checkboxes.forEach(cb => {
                    const type = cb.closest('.filter-item').querySelector('.filter-label').textContent.trim();
                    if (cb.checked) map.addLayer(layerGroups[type]);
                });
                return;
            }

            // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ëª¨ë“  ë ˆì´ì–´ë¥¼ ì¼ë‹¨ ìˆ¨ê¸°ê³ , ë§ëŠ” ê²ƒë§Œ ë³´ì—¬ì¤Œ
            for (const key in layerGroups) {
                map.removeLayer(layerGroups[key]);
            }

            allMarkers.forEach(item => {
                const name = item.data.name;
                const desc = item.data.desc || "";
                // ì´ë¦„ì´ë‚˜ ì„¤ëª…ì— ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ì§€ë„ì— ì¶”ê°€
                if (name.includes(keyword) || desc.includes(keyword)) {
                    item.marker.addTo(map);
                }
            });
        });

        // E. ì‚¬ì´ë“œë°” ì—´ê¸°/ë‹«ê¸° í† ê¸€
        function toggleSidebar() {
            const sidebar = document.getElementById('map-sidebar');
            sidebar.classList.toggle('open');
        }


        // ==========================================
        // 7. íŒì—… ë° ê¸°íƒ€ ê¸°ëŠ¥ (ê¸°ì¡´ ìœ ì§€)
        // ==========================================
        function generatePopupContent(item, storageKey, marker) {
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const isCompleted = completedList.includes(item.id);

            let html = `<div class="popup-container">
                <div class="popup-title">${item.name}</div>
                <div class="popup-type">â—ˆ ${item.type} â—ˆ</div>`;

            if (item.desc) html += `<div class="popup-desc">${item.desc}</div>`;

            html += `<div class="btn-container">`;
            if (item.link) html += `<a href="${item.link}" target="_blank" class="action-btn btn-wiki">ì§€ì¹¨ì„œ</a>`;

            const btnText = isCompleted ? "ì·¨ì†Œ" : "ì™„ë£Œ";
            const btnClass = isCompleted ? "btn-undo" : "btn-complete";
            
            // ë²„íŠ¼ í´ë¦­ ì‹œ toggleComplete í˜¸ì¶œ (ë§ˆì»¤ ê°ì²´ ì „ë‹¬ í•„ìš”ì—†ìŒ, ì „ì—­ ê°±ì‹ )
            html += `<button onclick="toggleComplete(${item.id}, '${storageKey}')" class="action-btn ${btnClass}">${btnText}</button>`;
            html += `</div>`; 

            if (item.image) html += `<img src="${item.image}" class="popup-img">`;
            html += `</div>`;
            return html;
        }

        window.toggleComplete = function(id, storageKey) {
            let completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const index = completedList.indexOf(id);
            
            // ì „ì—­ ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ ë§ˆì»¤ ì°¾ê¸°
            const targetItem = allMarkers.find(m => m.data.id === id);
            const marker = targetItem ? targetItem.marker : null;

            if (!marker) return;

            if (index > -1) {
                completedList.splice(index, 1);
                L.DomUtil.removeClass(marker._icon, 'marker-completed');
            } else {
                completedList.push(id);
                L.DomUtil.addClass(marker._icon, 'marker-completed');
            }
            localStorage.setItem(storageKey, JSON.stringify(completedList));
            marker.closePopup(); marker.openPopup();
        };

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => alert(`ì˜¤ë¥˜: ${err.message}`));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // (ê°œë°œìš©) í´ë¦­ ì¢Œí‘œ ë³µì‚¬
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);
            // í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì…ë ¥ í¼ íŒì—… ë¡œì§ ì¶”ê°€
        });

    </script>
</body>
</html>
