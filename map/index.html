<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ìš´ ëŒ€ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../map_style.css">
    <style>
        /* ë°°ê²½ìƒ‰ì„ ë°ì€ íšŒìƒ‰ìœ¼ë¡œ ì¤˜ì„œ ì§€ë„ê°€ íˆ¬ëª…í•œì§€ í™•ì¸ */
        #map { background: #f0f0f0; }
        /* íƒ€ì¼ ì´ë¯¸ì§€ê°€ í”½ì…€í™”ë˜ì–´ ë³´ì´ê²Œ ì„¤ì • (ì„ ëª…í•˜ê²Œ) */
        .leaflet-image-layer, .leaflet-layer {
            image-rendering: pixelated;
        }
    </style>
</head>
<body>

    <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" onclick="toggleSidebar()">
        <span>â˜°</span> Loading...
    </button>

    <div id="map-sidebar" class="map-sidebar">
        <div class="sidebar-close-btn" onclick="toggleSidebar()">âœ•</div>

        <div class="sidebar-header">
            <div class="map-select-area">
                <label class="sidebar-label">ì§€ì—­ ë³€ê²½</label>
                <select id="sidebar-map-select" class="sidebar-select"></select>
            </div>
            <div class="search-wrapper">
                <input type="text" id="marker-search" class="sidebar-search-input" placeholder="ì´ë¦„ ê²€ìƒ‰">
                <span class="search-icon">ğŸ”</span>
            </div>
            <div class="filter-controls" id="filter-controls-area">
                <button class="filter-control-btn" onclick="setAllFilters(true)">ëª¨ë‘ í‘œì‹œ</button>
                <button class="filter-control-btn" onclick="setAllFilters(false)">ëª¨ë‘ ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>

        <div id="filter-list" class="filter-list-container"></div>
        <div id="search-result-list" class="search-results-container"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. ë§µ ì„¤ì • (íƒ€ì¼ë§ì— ë§ê²Œ ìˆ˜ì •ë¨)
        // ==========================================
        const mapsDB = {
            "qinghe": {
                name: "ì²­í•˜",
                // â˜… ê²½ë¡œ í™•ì¸: ìƒìœ„ í´ë”(..)ì˜ tiles_qinghe í´ë”
                tileUrl: "../tiles_qinghe/{z}/{x}/{y}.png", 
                json: "../json/qinghe.json",
                w: 7306, h: 4732,
                // â˜… [ì¤‘ìš”] íƒ€ì¼ë§ì€ 0ì´ ìµœì†Œ(ì „ì²´ë³´ê¸°), 5ê°€ ìµœëŒ€(í™•ëŒ€)ì…ë‹ˆë‹¤.
                minZoom: 0, 
                maxZoom: 5 
            },
            "kaifeng": {
                name: "ê°œë´‰",
                img: "../kaifeng.jpg", 
                json: "../json/kaifeng.json",
                w: 8000, h: 6000,
                minZoom: -2, maxZoom: 2
            }
        };

        const typeMapping = { "ê²½ê³„ì„": "stone", "ìƒì": "chest", "ë§Œì‚¬ë¡": "ic_mansa", "ë³´ìŠ¤": "boss" };

        // ==========================================
        // 2. ì´ˆê¸°í™”
        // ==========================================
        const urlParams = new URLSearchParams(window.location.search);
        let currentMapId = urlParams.get('id') || "qinghe";
        if (!mapsDB[currentMapId]) currentMapId = "qinghe";
        const currentConfig = mapsDB[currentMapId];
        
        document.title = `${currentConfig.name} - ì—°ìš´ ì§€ë„`;
        const sidebarBtn = document.getElementById('sidebar-toggle-btn');
        if (sidebarBtn) sidebarBtn.innerHTML = `<span>â˜°</span> ${currentConfig.name}`;

        const config = { iconSize: [30, 30] };
        const layerGroups = {}; 
        const allMarkers = []; 

        // ==========================================
        // 3. ì§€ë„ ìƒì„± (íƒ€ì¼ë§ ìµœì í™”)
        // ==========================================
        
        // â˜… CRS.Simpleì€ ê¸°ë³¸ì ìœ¼ë¡œ (0,0)ì´ ì¢Œìƒë‹¨ì…ë‹ˆë‹¤.
        const map = L.map('map', {
            crs: L.CRS.Simple, 
            minZoom: currentConfig.minZoom,
            maxZoom: currentConfig.maxZoom, // ìµœëŒ€ ì¤Œ ì œí•œ
            zoomControl: false,
            attributionControl: false 
        });

        if (currentConfig.tileUrl) {
            // [A] íƒ€ì¼ ë°©ì‹ (ì²­í•˜)
            L.tileLayer(currentConfig.tileUrl, {
                minZoom: currentConfig.minZoom,
                maxZoom: currentConfig.maxZoom,
                tileSize: 256,
                noWrap: true,
                // bounds: íƒ€ì¼ì´ ì§€ë„ ì˜ì—­ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ ì œí•œ
                bounds: [[0, 0], [-currentConfig.h, currentConfig.w]]
            }).addTo(map);

        } else if (currentConfig.img) {
            // [B] í†µì´ë¯¸ì§€ ë°©ì‹ (ê°œë´‰ ì˜ˆë¹„ìš©)
            // í†µì´ë¯¸ì§€ëŠ” ì¢Œí•˜ë‹¨ì´ (0,0)ì¸ ì¢Œí‘œê³„ë¥¼ ì“°ë¯€ë¡œ boundsê°€ ë‹¤ë¦…ë‹ˆë‹¤.
            const bounds = [[0, 0], [currentConfig.h, currentConfig.w]];
            L.imageOverlay(currentConfig.img, bounds).addTo(map);
        }

        // ==========================================
        // 4. ì´ˆê¸° ì¤Œ ì„¤ì • (ì—¬ê¸°ê°€ ë¬¸ì œì˜€ìŒ!)
        // ==========================================
        const zoomSettings = {
            // â˜… íƒ€ì¼ ëª¨ë“œì—ì„œëŠ” 0~5 ì‚¬ì´ì˜ ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.
            // 2ë ˆë²¨: ì ë‹¹í•œ í™•ëŒ€, 0ë ˆë²¨: ì „ì²´ ë³´ê¸°
            pc: 2,        
            mobile: 1      
        };
        const isMobile = window.innerWidth <= 768;
        const targetZoom = isMobile ? zoomSettings.mobile : zoomSettings.pc;

        // ì¤‘ì•™ ì¢Œí‘œ (íƒ€ì¼ ì¢Œí‘œê³„ì—ì„œëŠ” Yê°€ ìŒìˆ˜ì¼ ìˆ˜ ìˆìŒ. ì¼ë‹¨ ì¤‘ì•™ìœ¼ë¡œ ì„¤ì •)
        // L.CRS.Simple ê¸°ë³¸ ì„¤ì •ìƒ Yì¶• ë°©í–¥ì´ í—·ê°ˆë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 
        // ì¼ë‹¨ (0, 0) ê·¼ì²˜ë‚˜ ì¤‘ì•™ìœ¼ë¡œ ì´ë™í•´ë´…ë‹ˆë‹¤.
        if (currentConfig.tileUrl) {
            // íƒ€ì¼ë§ ë§µì€ ë³´í†µ ì¢Œìƒë‹¨(0,0)ì—ì„œ ì‹œì‘í•´ ì•„ë˜ë¡œ ë‚´ë ¤ê°‘ë‹ˆë‹¤.
            // ì¼ë‹¨ ê°•ì œë¡œ -height/2 (ì¤‘ì•™)ì„ ì¤˜ë´…ë‹ˆë‹¤.
            map.setView([-currentConfig.h / 2, currentConfig.w / 2], targetZoom);
        } else {
            // í†µì´ë¯¸ì§€ ë§µ
            map.setView([currentConfig.h / 2, currentConfig.w / 2], -2);
        }

        // ì»¨íŠ¸ë¡¤ ë°°ì¹˜
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const FullscreenControl = L.Control.extend({
            options: { position: 'bottomright' },
            onAdd: function () {
                const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const b = L.DomUtil.create('a', 'leaflet-control-fullscreen', c);
                b.href = '#'; b.innerHTML = 'â›¶'; b.onclick = (e) => { e.preventDefault(); toggleFullscreen(); };
                return c;
            }
        });
        map.addControl(new FullscreenControl());

        // ë§µ ì„ íƒê¸°
        const mapSelect = document.getElementById('sidebar-map-select');
        for (const [key, val] of Object.entries(mapsDB)) {
            const option = document.createElement('option');
            option.value = key; option.innerText = val.name;
            if (key === currentMapId) option.selected = true;
            mapSelect.appendChild(option);
        }
        mapSelect.onchange = function() { window.location.search = `?id=${this.value}`; };

        // ==========================================
        // 5. ë°ì´í„° ë¡œë”©
        // ==========================================
        fetch(currentConfig.json)
            .then(res => res.json())
            .then(data => {
                createMarkers(data);
                generateSidebar(data);
            })
            .catch(err => { console.error(err); });

        function createMarkers(data) {
            const storageKey = `completed_${currentMapId}`;
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];

            data.forEach(item => {
                if (!layerGroups[item.type]) layerGroups[item.type] = L.layerGroup();
                const imgName = typeMapping[item.type] || item.type;
                const isCompleted = completedList.includes(item.id);
                const myIcon = L.icon({
                    iconUrl: `../images/${imgName}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], 
                    popupAnchor: [0, -config.iconSize[1]],
                    className: isCompleted ? 'marker-completed' : ''
                });

                // â˜… [ì¢Œí‘œ ë³´ì •]
                // íƒ€ì¼ë§ ë°©ì‹ê³¼ JSON ì¢Œí‘œê³„ê°€ ë°˜ëŒ€(ìœ„ì•„ë˜)ì¼ ê²½ìš°
                // item.y ëŒ€ì‹  (-item.y) ë˜ëŠ” (Height - item.y)ë¥¼ ì¨ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // ì¼ë‹¨ ê·¸ëŒ€ë¡œ(item.y) ì°ì–´ë³´ê³ , ë§ˆì»¤ê°€ ì•ˆ ë³´ì´ë©´ 
                // ì•„ë˜ ì¤„ì„ `const markerY = -item.y;` ë¡œ ë°”ê¿”ë³´ì„¸ìš”.
                const markerY = -item.y; // â˜… íƒ€ì¼ë§ì€ ë³´í†µ Yê°€ ìŒìˆ˜ë¡œ ë‚´ë ¤ê°‘ë‹ˆë‹¤.
                
                const marker = L.marker([markerY, item.x], { icon: myIcon });
                marker.bindPopup(() => generatePopupContent(item, storageKey));
                layerGroups[item.type].addLayer(marker);
                allMarkers.push({ id: item.id, name: item.name, desc: item.desc || "", type: item.type, marker: marker });
            });

            for (const key in layerGroups) layerGroups[key].addTo(map);
        }

        // ==========================================
        // 6. ì‚¬ì´ë“œë°” ë° ê¸°íƒ€ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
        // ==========================================
        const searchInput = document.getElementById('marker-search');
        const filterList = document.getElementById('filter-list');
        const searchResultList = document.getElementById('search-result-list');
        const filterControls = document.getElementById('filter-controls-area');

        searchInput.addEventListener('input', function(e) {
            const keyword = e.target.value.trim().toLowerCase();
            if (keyword === "") {
                filterList.classList.remove('hidden');
                filterControls.style.display = 'flex';
                searchResultList.classList.remove('active');
                return;
            }
            filterList.classList.add('hidden');
            filterControls.style.display = 'none';
            searchResultList.classList.add('active');
            searchResultList.innerHTML = '';
            const results = allMarkers.filter(item => item.name.toLowerCase().includes(keyword) || item.desc.toLowerCase().includes(keyword));
            if (results.length === 0) {
                searchResultList.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            results.forEach(item => {
                const row = document.createElement('div');
                row.className = 'search-result-row';
                const imgName = typeMapping[item.type] || item.type;
                row.innerHTML = `<div class="result-info"><div class="result-name">${item.name}</div><div class="result-desc">${item.desc}</div></div><img src="../images/${imgName}.png" class="result-type-icon" onerror="this.style.display='none'">`;
                row.onclick = () => {
                    if (!map.hasLayer(layerGroups[item.type])) map.addLayer(layerGroups[item.type]);
                    const jumpZoom = Math.min(map.getZoom() + 2, currentConfig.maxZoom); 
                    map.flyTo(item.marker.getLatLng(), jumpZoom, { animate: true, duration: 1.5 });
                    setTimeout(() => { item.marker.openPopup(); }, 1000);
                    if (window.innerWidth <= 480) toggleSidebar();
                };
                searchResultList.appendChild(row);
            });
        });

        function generateSidebar(data) {
            filterList.innerHTML = '';
            const counts = {};
            data.forEach(item => counts[item.type] = (counts[item.type] || 0) + 1);
            for (const [type, count] of Object.entries(counts)) {
                const div = document.createElement('div');
                div.className = 'filter-item';
                const imgName = typeMapping[type] || type;
                div.innerHTML = `<label class="filter-label" style="cursor:pointer; width:100%;"><input type="checkbox" class="filter-checkbox" checked onchange="toggleLayer('${type}', this.checked)"><img src="../images/${imgName}.png" width="24" height="24" onerror="this.style.display='none'" style="vertical-align:middle; margin-right:5px;"> ${type}</label><span class="filter-count">${count}</span>`;
                filterList.appendChild(div);
            }
        }
        function toggleLayer(type, isChecked) { isChecked ? map.addLayer(layerGroups[type]) : map.removeLayer(layerGroups[type]); }
        function setAllFilters(status) {
            document.querySelectorAll('.filter-checkbox').forEach(cb => {
                cb.checked = status;
                const type = cb.parentElement.innerText.trim();
                toggleLayer(type, status);
            });
        }
        function toggleSidebar() { document.getElementById('map-sidebar').classList.toggle('open'); }
        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
            else if (document.exitFullscreen) document.exitFullscreen();
        }
        function generatePopupContent(item, storageKey) {
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const isCompleted = completedList.includes(item.id);
            let html = `<div class="popup-container"><div class="popup-title">${item.name}</div><div class="popup-type">â—ˆ ${item.type} â—ˆ</div>`;
            if (item.desc) html += `<div class="popup-desc">${item.desc}</div>`;
            html += `<div class="btn-container">`;
            if (item.link) html += `<a href="${item.link}" target="_blank" class="action-btn btn-wiki">ì§€ì¹¨ì„œ</a>`;
            const btnText = isCompleted ? "ì·¨ì†Œ" : "ì™„ë£Œ";
            const btnClass = isCompleted ? "btn-undo" : "btn-complete";
            html += `<button onclick="toggleComplete(${item.id}, '${storageKey}')" class="action-btn ${btnClass}">${btnText}</button></div>`;
            if (item.image) html += `<img src="${item.image}" class="popup-img">`;
            html += `</div>`;
            return html;
        }
        window.toggleComplete = function(id, storageKey) {
            let list = JSON.parse(localStorage.getItem(storageKey)) || [];
            const index = list.indexOf(id);
            const target = allMarkers.find(m => m.id === id);
            const marker = target ? target.marker : null;
            if (!marker) return;
            if (index > -1) {
                list.splice(index, 1);
                L.DomUtil.removeClass(marker._icon, 'marker-completed');
            } else {
                list.push(id);
                L.DomUtil.addClass(marker._icon, 'marker-completed');
            }
            localStorage.setItem(storageKey, JSON.stringify(list));
            marker.closePopup(); marker.openPopup();
        };
        
        // ê°œë°œìš© í´ë¦­ ì¢Œí‘œ
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);
            const content = `<div class="input-group"><h4 style="margin:0 0 10px 0;text-align:center;">ìƒˆ ìœ„ì¹˜</h4><label>ì´ë¦„</label><input type="text" id="input_name"><label>ì¢…ë¥˜</label><select id="input_type"><option value="ê²½ê³„ì„">ê²½ê³„ì„</option><option value="ìƒì">ìƒì</option></select><button class="copy-btn" onclick="copyMarkerJson(${y}, ${x})">JSON ë³µì‚¬</button></div>`;
            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
        });
        window.copyMarkerJson = function(y, x) {
            // y ì¢Œí‘œ ë¶€í˜¸ ì›ë˜ëŒ€ë¡œ (ìŒìˆ˜ì˜€ë‹¤ë©´ ì–‘ìˆ˜ë¡œ)
            const jsonY = Math.abs(y); 
            const name = document.getElementById('input_name').value;
            const type = document.getElementById('input_type').value;
            const str = `, { "id": ${Date.now()}, "name": "${name}", "type": "${type}", "y": ${jsonY}, "x": ${x} }`;
            navigator.clipboard.writeText(str).then(()=>alert("ë³µì‚¬ë¨"));
        };
    </script>
</body>
</html>