<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ìš´ í•œêµ­ì–´ ë§µ for Wiki</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5SMVDZTDST"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5SMVDZTDST');
    </script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link rel="stylesheet" href="../map_style.css">
    
    <meta property="og:type" content="website">
    <meta property="og:description" content="ì—°ìš´ í•œêµ­ ìœ„í‚¤ì—ì„œ ì œê³µí•˜ëŠ” í•œêµ­ì–´ ë§µì…ë‹ˆë‹¤.">
    <link rel="icon" type="image/png" sizes="32x32" href="../fav/favicon-32x32.png">
    <style>
        #map { background: #1a1a1a; }
        .dev-mode-cursor { cursor: crosshair !important; }

        /* =========================================
           1. í•€ ë””ìì¸ (ê¸°ë³¸ ë§ˆì»¤)
           ========================================= */
        .pin-marker {
            position: relative;
            width: 100%; height: 100%;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            background: #ffffff;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            box-sizing: border-box;
            will-change: transform; 
            transition: transform 0.2s, z-index 0.2s;
        }
        .pin-inner-circle {
            width: 88%; height: 88%;
            border-radius: 50%;
            background: var(--pin-color, #555);
            display: flex; align-items: center; justify-content: center;
        }
        .pin-inner-circle img {
            width: 70%; height: 70%;
            object-fit: contain;
            transform: rotate(45deg);
            opacity: 1;
        }
        .pin-marker:hover {
            transform: rotate(-45deg) scale(1.15);
            z-index: 9999; cursor: pointer;
        }
        .marker-completed .pin-inner-circle { background: #999 !important; }

        /* =========================================
           2. ìƒë‹¨ ë²„íŠ¼ ê·¸ë£¹ (ë†’ì´/ìœ„ì¹˜ ì™„ë²½ ì •ë ¬)
           ========================================= */
        .top-controls-wrapper {
            position: absolute;
            top: 10px; left: 10px;
            z-index: 1000;
            display: flex; gap: 10px;
            align-items: center;
        }

        /* ê¸°ì¡´ ì‚¬ì´ë“œë°” ë²„íŠ¼ ê°•ì œ ì¬ì •ì˜ */
        .sidebar-toggle-btn {
            position: static !important;
            margin: 0 !important;
            height: 40px !important;
            padding: 0 15px !important;
            font-size: 14px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
        }

        /* ëª¨ì•„ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .cluster-toggle-btn {
            position: static;
            height: 40px;
            padding: 0 15px;
            font-size: 14px;
            font-family: 'Noto Serif KR', serif;
            font-weight: bold;
            line-height: 1;
            background-color: #1a1a1a;
            color: #ffffff;
            border: 1px solid #a08040;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            gap: 6px;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        .cluster-toggle-btn:hover { background-color: #333; transform: translateY(-1px); }
        .cluster-toggle-btn.off { background-color: #333; border-color: #666; color: #aaa; }

        /* =========================================
           3. ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ë¦¬ë‰´ì–¼ (ë‹¤í¬ í…Œë§ˆ + 2ì—´ ê·¸ë¦¬ë“œ)
           ========================================= */
     
                /* =========================================
           3. ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ë¦¬ë‰´ì–¼ (í™”ì´íŠ¸ í…Œë§ˆ ë³µê·€)
           ========================================= */
        
        /* 1. ì‚¬ì´ë“œë°” ì „ì²´ ë°°ê²½ (ë‹«ê¸° ë²„íŠ¼ê³¼ ìƒ‰ìƒ í†µì¼) */
        .map-sidebar {
            background-color: #f9f9f9 !important; /* â˜… ë°°ê²½ì„ ë°ì€ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ */
            border-right: 1px solid #a08040 !important; /* í…Œë‘ë¦¬ ê¸ˆìƒ‰ */
            color: #1a1a1a !important; /* â˜… ê¸€ììƒ‰ì„ ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        }

        /* 2. í—¤ë” ë° ê²€ìƒ‰ì°½ */
        .sidebar-header {
            background-color: #f9f9f9 !important; /* í—¤ë” ë°°ê²½ë„ í†µì¼ */
            border-bottom: 1px solid #dcdcdc !important;
        }
        .sidebar-label { color: #a08040 !important; }
        
        /* ì…ë ¥ì°½, ì„ íƒì°½, ë²„íŠ¼ (í°ìƒ‰ ë°°ê²½ + ê²€ì€ ê¸€ì”¨) */
        .sidebar-search-input, .sidebar-select, .filter-control-btn {
            background-color: #ffffff !important;
            border: 1px solid #dcdcdc !important;
            color: #1a1a1a !important;
        }
        .filter-control-btn:hover { 
            border-color: #a08040 !important; 
            color: #a08040 !important; 
            background-color: #fffcf5 !important;
        }

        /* 3. í•„í„° ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ */
        .filter-list-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            align-content: start;
        }

        /* 4. ê°œë³„ í•„í„° ì•„ì´í…œ */
        .filter-item {
            display: flex; align-items: center; justify-content: space-between;
            background-color: transparent;
            padding: 5px 0;
            border-bottom: none !important;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .filter-left-group { display: flex; align-items: center; gap: 8px; flex: 1; }
        .filter-icon-img { width: 20px; height: 20px; object-fit: contain; }
        
        /* â˜… í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ (ê²€ì€ìƒ‰ ë°°ê²½ìš© -> í°ìƒ‰ ë°°ê²½ìš©) */
        .filter-text-name { 
            font-size: 0.9em; 
            color: #555; /* í‰ì†Œì—” ì§„í•œ íšŒìƒ‰ */
            font-weight: normal; 
        }
        .filter-count { 
            background: none !important; 
            color: #888 !important; /* ìˆ«ìë„ íšŒìƒ‰ */
            font-size: 0.9em; 
            padding: 0; 
        }

        /* í™œì„±í™” ìƒíƒœ (ON) - ì§„í•œ ê²€ì • */
        .filter-item.active .filter-text-name { 
            color: #000; /* í™œì„±í™” ì‹œ ì™„ì „ ê²€ì • */
            font-weight: bold; 
        }
        .filter-item.active .filter-icon-img { opacity: 1; }

        /* ë¹„í™œì„±í™” ìƒíƒœ (OFF) - ì—°í•œ íšŒìƒ‰ + ì·¨ì†Œì„  */
        .filter-item.inactive { opacity: 0.5; }
        .filter-item.inactive .filter-text-name { 
            text-decoration: line-through; 
            color: #aaa; 
        }
        .filter-item.inactive .filter-icon-img { filter: grayscale(100%); }

        /* =========================================
           4. ì‹¬í”Œ í´ëŸ¬ìŠ¤í„° (ìƒ‰ìƒ ì› + ìˆ«ì)
           ========================================= */
        .simple-cluster-marker {
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 2px solid #ffffff;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; /* ê¸€ì í¬ê¸° ì¡°ì • */
            font-weight: bold;
            font-family: 'Noto Serif KR', serif;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            transition: transform 0.2s ease;
        }
        .simple-cluster-marker:hover { transform: scale(1.15); cursor: pointer; z-index: 5000; }
    </style>
</head>
<body>

    <div class="top-controls-wrapper">
        <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" onclick="toggleSidebar()">
            <span>â˜°</span> Loading...
        </button>
        <button id="cluster-toggle-btn" class="cluster-toggle-btn" onclick="toggleClusterMode()">
            Checking...
        </button>
    </div>

    <div id="map-sidebar" class="map-sidebar">
        <div class="sidebar-close-btn" onclick="toggleSidebar()">âœ•</div>
        <div class="sidebar-header">
            <div class="map-select-area">
                <label class="sidebar-label">ì§€ì—­ ë³€ê²½</label>
                <select id="sidebar-map-select" class="sidebar-select"></select>
            </div>
            <div class="search-wrapper">
                <input type="text" id="marker-search" class="sidebar-search-input" placeholder="ì´ë¦„ ê²€ìƒ‰">
                <span class="search-icon">ğŸ”</span>
            </div>
            <div class="filter-controls" id="filter-controls-area">
                <button class="filter-control-btn" onclick="setAllFilters(true)">ëª¨ë‘ í‘œì‹œ</button>
                <button class="filter-control-btn" onclick="setAllFilters(false)">ëª¨ë‘ ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="filter-list" class="filter-list-container"></div>
        <div id="search-result-list" class="search-results-container"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // ==========================================
        // 1. ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
        // ==========================================
        const mapsDB = {
            "qinghe": { name: "ì²­í•˜", img: "../map/images/qinghe.jpg", json: "../json/qinghe.json", w: 7306, h: 4732 },
            "gesh": { name: "ì¥êµ° ì‚¬ë‹¹", img: "../map/images/gesh.jpg", json: "../json/gesh.json", w: 1662, h: 1787 },
            "drs": { name: "ê¿ˆì†ì˜ ë¶ˆì„ ì„ ", img: "../map/images/dream.jpg", json: "../json/drs.json", w: 4545, h: 2743 },
            "kaifeng": { name: "ê°œë´‰", img: "../map/images/kaifeng.jpg", json: "../json/kaifeng.json", w: 5159, h: 7000 },
            "gm": { name: "ê·€ë¬¸ì‹œì¥", img: "../map/images/gm.jpg", json: "../json/gm.json", w: 5482, h: 3534 }
            
        };

 // íƒ€ì… ë° ìƒ‰ìƒ ë§¤í•‘
    const typeMapping = { 
        "ê²½ê³„ì„": "ic_pin", "ë¬˜ë¬˜ëƒ¥": "ic_mew", "ê³ ì–‘ì´": "ic_cat",
        "ë§Œì‚¬ë¡": "ic_mansa", "ë¬˜ë¬¼": "ic_uni", "ìƒì": "ic_chest", 
        "ë³´ìŠ¤": "ic_boss", "ê¸°ì—°": "ic_ki", "ì²œì§€ë¡": "ic_cj","ì‚¬ê±´":"ic_pvp",
        "ë‚šì‹œëŒ€ê²°":"ic_fish","íˆ¬í˜¸ëŒ€ê²°":"ic_two","ì˜ì§€":"ic_camp","ê°•í˜¸ì˜ë²—":"ic_pic","ìœ ë¬¼":"ic_tr",
        "íƒë°©":"logo","ë§Œë¬¼ì˜ìš¸ë¦¼":"ic_man","ê³¡ê²½ì‹¬ìœ ":"ic_gk","ê¶ìˆ ëŒ€ê²°":"logo","ê¸°íƒ€":"logo","ì•¼ì™¸ì œì‚¬":"logo",
        "ë¬´ìˆ ë¡œë§ºì€ì¸ì—°":"logo", "í’ë¥˜ì˜ì„ ë¥ ":"logo", "ì˜ìˆ ì¹˜ìœ ":"logo", "ì±„ì§‘":"logo","í™”ì¥ì‹¤":"ic_tl"
    };

       const colorMapping = {
        "ìƒì": "#4CAF50", // ë°ì€ ì´ˆë¡
        "ë³´ìŠ¤": "#F44336", // ë°ì€ ë¹¨ê°•
        "ê³ ì–‘ì´": "#607D8B", // íŒŒë€ íšŒìƒ‰ (ê²€ì •ì€ ë„ˆë¬´ ì–´ë‘ì›Œì„œ ë³€ê²½)
        "ë¬˜ë¬¼": "#009688", // ë°ì€ ì²­ë¡
        "ë§Œì‚¬ë¡": "#FF9800", // ì£¼í™©
        "ê²½ê³„ì„": "#9C27B0", // ë°ì€ ë³´ë¼
        "ê¸°ì—°": "#E91E63", // ì§„í•œ ë¶„í™
        "ë¬˜ë¬˜ëƒ¥": "#673AB7", // ì§™ì€ ë³´ë¼
        "ì²œì§€ë¡": "#2196F3", // ë°ì€ íŒŒë‘
        "ì‚¬ê±´": "#3F51B5",
        "ë‚šì‹œëŒ€ê²°":"#272a57",
        "íˆ¬í˜¸ëŒ€ê²°":"#272a57",
        "ì˜ì§€":"#d8d5a8",
        "ê°•í˜¸ì˜ë²—":"#fbceb1",
        "ìœ ë¬¼":"#003458",
        "íƒë°©":"#fbceb1",
        "ë§Œë¬¼ì˜ìš¸ë¦¼":"#fbceb1","ê³¡ê²½ì‹¬ìœ ":"#fbceb1","ê¶ìˆ ëŒ€ê²°":"#fbceb1","ê¸°íƒ€":"#fbceb1","ì•¼ì™¸ì œì‚¬":"#fbceb1",
        "ë¬´ìˆ ë¡œë§ºì€ì¸ì—°":"#fbceb1", "í™”ìˆ ë…¼ìŸ":"#fbceb1", "í’ë¥˜ì˜ì„ ë¥ ":"#fbceb1", "ì˜ìˆ ì¹˜ìœ ":"logo", "ì±„ì§‘":"logo"
        
    };

        const urlParams = new URLSearchParams(window.location.search);
        let rawId = urlParams.get('id') || "qinghe";
        const isDevMode = rawId.endsWith('_dev');
        let currentMapId = isDevMode ? rawId.replace('_dev', '') : rawId;

        if (!mapsDB[currentMapId]) currentMapId = "qinghe";
        const currentConfig = mapsDB[currentMapId];
        
        document.title = `${currentConfig.name} - ì—°ìš´ ì§€ë„`;
        const sidebarBtn = document.getElementById('sidebar-toggle-btn');
        if (sidebarBtn) sidebarBtn.innerHTML = `<span>â˜°</span> ${currentConfig.name}`;

        const isMobile = window.innerWidth <= 768;
        const pinSize = isMobile ? [24, 24] : [30, 30];

        // ì „ì—­ ë³€ìˆ˜
        let layerGroups = {}; 
        let allMarkers = []; 
        let cachedData = null; 
        let isClusterOn = localStorage.getItem('clusterMode') !== 'false'; // ê¸°ë³¸ê°’ ON

        // ==========================================
        // 2. ì§€ë„ ìƒì„±
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple, minZoom: -5, maxZoom: 2, zoomControl: false, attributionControl: false
        });

        if (isDevMode) document.getElementById('map').classList.add('dev-mode-cursor');

        const bounds = [[0, 0], [currentConfig.h, currentConfig.w]];
        L.imageOverlay(currentConfig.img, bounds).addTo(map);

        const zoomSettings = { pc: -1.5, mobile: -2.5 };
        const targetZoom = isMobile ? zoomSettings.mobile : zoomSettings.pc;
        map.setView([currentConfig.h / 2, currentConfig.w / 2], targetZoom);

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        map.addControl(new (L.Control.extend({
            options: { position: 'bottomright' },
            onAdd: function () {
                const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const b = L.DomUtil.create('a', 'leaflet-control-fullscreen', c);
                b.href = '#'; b.innerHTML = 'â›¶'; b.onclick = (e) => { e.preventDefault(); toggleFullscreen(); };
                return c;
            }
        }))());

        const mapSelect = document.getElementById('sidebar-map-select');
        for (const [key, val] of Object.entries(mapsDB)) {
            const option = document.createElement('option');
            option.value = key; option.innerText = val.name;
            if (key === currentMapId) option.selected = true;
            mapSelect.appendChild(option);
        }
        mapSelect.onchange = function() {
            const nextId = this.value + (isDevMode ? '_dev' : '');
            window.location.search = `?id=${nextId}`;
        };

        // ==========================================
        // 3. ë°ì´í„° ë¡œë”© ë° ì‹¤í–‰
        // ==========================================
        fetch(currentConfig.json)
            .then(res => res.json())
            .then(data => {
                cachedData = data;
                updateClusterButton(); 
                createMarkers(data);
                generateSidebar(data);
            })
            .catch(err => { console.error(err); });

        // ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
        function updateClusterButton() {
            const btn = document.getElementById('cluster-toggle-btn');
            if (isClusterOn) {
                btn.innerHTML = `<span style="color:#a08040; font-size:1.2em; line-height:0;">â—</span> ëª¨ì•„ë³´ê¸° ON`;
                btn.classList.remove('off');
                btn.style.border = "1px solid #a08040";
                btn.style.color = "white";
            } else {
                btn.innerHTML = `<span style="color:#888; font-size:1.2em; line-height:0;">â—‹</span> ëª¨ì•„ë³´ê¸° OFF`;
                btn.classList.add('off');
                btn.style.border = "1px solid #666";
                btn.style.color = "#aaa";
            }
        }

        // í† ê¸€ ê¸°ëŠ¥
        window.toggleClusterMode = function() {
            isClusterOn = !isClusterOn;
            localStorage.setItem('clusterMode', isClusterOn);
            updateClusterButton();
            
            for (const key in layerGroups) map.removeLayer(layerGroups[key]);
            layerGroups = {};
            allMarkers = [];

            if (cachedData) {
                createMarkers(cachedData);
                generateSidebar(cachedData); // ì‚¬ì´ë“œë°” ìƒíƒœ(active/inactive) ë™ê¸°í™” ìœ„í•´ ë‹¤ì‹œ í˜¸ì¶œ
            }
        };

        // ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
                // ë§ˆì»¤ ìƒì„± í•¨ìˆ˜ (ìµœì í™” ì ìš©ë¨)
        function createMarkers(data) {
            const storageKey = `completed_${currentMapId}`;
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const lightTypes = [""]; 

            // 1. ì„ì‹œ ì €ì¥ì†Œ ìƒì„± (íƒ€ì…ë³„ë¡œ ë§ˆì»¤ë¥¼ ëª¨ì•„ë‘ê¸° ìœ„í•¨)
            const markersByType = {}; 

            data.forEach(item => {
                // íƒ€ì…ë³„ ë°°ì—´ ì´ˆê¸°í™”
                if (!markersByType[item.type]) {
                    markersByType[item.type] = [];
                }

                // ê°œë³„ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
                const isCompleted = completedList.includes(item.id);
                const imgName = typeMapping[item.type] || "logo"; 
                const iconPath = `../images/${imgName}.png`;
                const pinColor = colorMapping[item.type] || colorMapping["ê¸°íƒ€"];

                const pinIcon = L.divIcon({
                    className: isCompleted ? 'marker-completed' : '',
                    html: `<div class="pin-marker">
                               <div class="pin-inner-circle" style="--pin-color: ${pinColor};">
                                   <img src="${iconPath}" onerror="this.src='../images/logo.png'">
                               </div>
                           </div>`,
                    iconSize: pinSize, 
                    iconAnchor: [pinSize[0]/2, pinSize[1] * 0.9], 
                    popupAnchor: [0, -(pinSize[1] * 0.8)]
                });

                const marker = L.marker([item.y, item.x], { icon: pinIcon });
                marker.bindPopup(() => generatePopupContent(item, storageKey));
                
                // 2. ë°”ë¡œ ì§€ë„ì— ë„£ì§€ ì•Šê³ , ë°°ì—´ì— push (ì¤‘ìš”!)
                markersByType[item.type].push(marker);

                // ê²€ìƒ‰ ë“±ì„ ìœ„í•œ ì „ì²´ ë¦¬ìŠ¤íŠ¸ì—ëŠ” ê·¸ëŒ€ë¡œ ì €ì¥
                allMarkers.push({ id: item.id, name: item.name, desc: item.desc || "", type: item.type, marker: marker });
            });

            // 3. ëª¨ì•„ë‘” ë§ˆì»¤ë¥¼ ê·¸ë£¹ë³„ë¡œ í•œ ë²ˆì— ì²˜ë¦¬
            for (const type in markersByType) {
                const markersArray = markersByType[type];

                if (isClusterOn) {
                    // === í´ëŸ¬ìŠ¤í„° ëª¨ë“œ ===
                    const typeColor = colorMapping[type] || "#555";
                    const isLight = lightTypes.includes(type);
                    const badgeTextColor = isLight ? "#000000" : "#ffffff";
                    const textShadowStyle = isLight ? "none" : "0 0 2px rgba(0,0,0,0.5)";

                    // ê·¸ë£¹ì´ ì—†ìœ¼ë©´ ìƒì„±
                    if (!layerGroups[type]) {
                        layerGroups[type] = L.markerClusterGroup({
                            disableClusteringAtZoom: 0,
                            spiderfyOnMaxZoom: true,
                            showCoverageOnHover: false, 
                            chunkedLoading: true,      // ë¹„ë™ê¸° ë¡œë”© ìœ ì§€
                            animate: false,            // â˜… [ìµœì í™”] ì• ë‹ˆë©”ì´ì…˜ ë„ê¸° (ì„±ëŠ¥ í–¥ìƒ í¼)
                            animateAddingMarkers: false, // â˜… [ìµœì í™”] ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜ ë„ê¸°
                            maxClusterRadius: 80,      // â˜… [ìµœì í™”] ë­‰ì¹˜ëŠ” ë°˜ê²½ (ê¸°ë³¸ 80, ë ‰ ê±¸ë¦¬ë©´ 100ìœ¼ë¡œ ëŠ˜ë ¤ë³´ì„¸ìš”)
                            iconCreateFunction: function(cluster) {
                                const count = cluster.getChildCount();
                                const countText = count > 99 ? '99+' : count;
                                const html = `
                                    <div class="simple-cluster-marker" style="background-color: ${typeColor}; color: ${badgeTextColor}; text-shadow: ${textShadowStyle};">
                                        ${countText}
                                    </div>`;
                                return L.divIcon({
                                    html: html, className: '',
                                    iconSize: [28, 28],
                                    iconAnchor: [14, 14]
                                });
                            }
                        });
                    }
                    // â˜… [í•µì‹¬] ë°°ì—´ í†µì§¸ë¡œ ì¶”ê°€ (addLayer -> addLayers)
                    layerGroups[type].addLayers(markersArray);

                } else {
                    // === ì¼ë°˜ ëª¨ë“œ ===
                    // ì¼ë°˜ ëª¨ë“œë„ LayerGroupì— ë°°ì—´ë¡œ í•œ ë²ˆì— ë„£ëŠ” ê²ƒì´ ì¢‹ìŒ
                    if (!layerGroups[type]) {
                        layerGroups[type] = L.layerGroup(); 
                    }
                    markersArray.forEach(m => layerGroups[type].addLayer(m));
                }
            }

            // 4. ì €ì¥ëœ í•„í„° ì„¤ì • í™•ì¸ í›„ ë ˆì´ì–´ ì¶”ê°€ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            const savedFilters = JSON.parse(localStorage.getItem('map_filter_settings')) || {};
            for (const key in layerGroups) {
                const shouldShow = (savedFilters[key] !== undefined) ? savedFilters[key] : true;
                if (shouldShow) {
                    layerGroups[key].addTo(map);
                }
            }

            // URL íŒŒë¼ë¯¸í„° ì´ë™ ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            const targetId = urlParams.get('marker');
            if (targetId) {
                const target = allMarkers.find(m => m.id == targetId);
                if (target) {
                    if (!map.hasLayer(layerGroups[target.type])) map.addLayer(layerGroups[target.type]);
                    if (isClusterOn && layerGroups[target.type].zoomToShowLayer) {
                        layerGroups[target.type].zoomToShowLayer(target.marker, function() {
                            target.marker.openPopup();
                        });
                    } else {
                        map.setView(target.marker.getLatLng(), 0);
                        setTimeout(() => target.marker.openPopup(), 500);
                    }
                }
            }
        }

// [ì¶”ê°€ë¨] í˜„ì¬ í•„í„° ìƒíƒœë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
        function saveFilterState() {
            const status = {};
            for (const key in layerGroups) {
                // ì§€ë„ì— ë ˆì´ì–´ê°€ ì˜¬ë¼ì™€ ìˆìœ¼ë©´ true, ì—†ìœ¼ë©´ false
                status[key] = map.hasLayer(layerGroups[key]);
            }
            localStorage.setItem('map_filter_settings', JSON.stringify(status));
        }
        // ==========================================
        // 4. ì‚¬ì´ë“œë°” ë¡œì§ (ë¦¬ë‰´ì–¼ë¨)
        // ==========================================
        const searchInput = document.getElementById('marker-search');
        const filterList = document.getElementById('filter-list');
        const searchResultList = document.getElementById('search-result-list');
        const filterControls = document.getElementById('filter-controls-area');

        searchInput.addEventListener('input', function(e) {
            const keyword = e.target.value.trim().toLowerCase();
            if (keyword === "") {
                filterList.classList.remove('hidden'); filterControls.style.display = 'flex'; searchResultList.classList.remove('active'); return;
            }
            filterList.classList.add('hidden'); filterControls.style.display = 'none'; searchResultList.classList.add('active'); searchResultList.innerHTML = '';
            const results = allMarkers.filter(item => item.name.toLowerCase().includes(keyword) || item.desc.toLowerCase().includes(keyword));
            if (results.length === 0) { searchResultList.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            results.forEach(item => {
                const row = document.createElement('div'); row.className = 'search-result-row';
                const imgName = typeMapping[item.type] || "logo";
                row.innerHTML = `<div class="result-info"><div class="result-name">${item.name}</div><div class="result-desc">${item.desc}</div></div><img src="../images/${imgName}.png" class="result-type-icon" onerror="this.style.display='none'">`;
                row.onclick = () => {
                    if (!map.hasLayer(layerGroups[item.type])) map.addLayer(layerGroups[item.type]);
                    const jumpZoom = Math.min(map.getZoom() + 3, 1); 
                    map.flyTo(item.marker.getLatLng(), jumpZoom, { animate: true, duration: 1.5 });
                    setTimeout(() => { item.marker.openPopup(); }, 1000);
                    if (window.innerWidth <= 480) toggleSidebar();
                };
                searchResultList.appendChild(row);
            });
        });

        // ì‚¬ì´ë“œë°” ìƒì„± (í´ë¦­ í† ê¸€ ë°©ì‹)
        function generateSidebar(data) {
            filterList.innerHTML = '';
            const counts = {};
            data.forEach(item => counts[item.type] = (counts[item.type] || 0) + 1);

            for (const [type, count] of Object.entries(counts)) {
                const div = document.createElement('div');
                const isActive = layerGroups[type] && map.hasLayer(layerGroups[type]);
                div.className = `filter-item ${isActive ? 'active' : 'inactive'}`;
                
                const imgName = typeMapping[type] || "logo";
                div.innerHTML = `
                    <div class="filter-left-group">
                        <img src="../images/${imgName}.png" class="filter-icon-img" onerror="this.style.display='none'">
                        <span class="filter-text-name">${type}</span>
                    </div>
                    <span class="filter-count">${count}</span>`;

                div.onclick = function() {
                    const isNowActive = div.classList.contains('active');
                    if (isNowActive) {
                        div.classList.remove('active'); div.classList.add('inactive');
                        toggleLayer(type, false);
                    } else {
                        div.classList.remove('inactive'); div.classList.add('active');
                        toggleLayer(type, true);
                    }
                    saveFilterState(); // â˜…
                };
                filterList.appendChild(div);
            }
        }

        function toggleLayer(type, isChecked) {
            if (isChecked) {
                if (layerGroups[type]) map.addLayer(layerGroups[type]);
            } else {
                if (layerGroups[type]) map.removeLayer(layerGroups[type]);
            }
        }

        function setAllFilters(status) {
            const items = document.querySelectorAll('.filter-item');
            items.forEach(div => {
                const typeName = div.querySelector('.filter-text-name').innerText;
                if (status) {
                    div.classList.remove('inactive'); div.classList.add('active');
                    toggleLayer(typeName, true);
                } else {
                    div.classList.remove('active'); div.classList.add('inactive');
                    toggleLayer(typeName, false);
                }
                
            });
            saveFilterState(); // â˜…
        }

        function toggleSidebar() { document.getElementById('map-sidebar').classList.toggle('open'); }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {}); else if (document.exitFullscreen) document.exitFullscreen(); }

        // ==========================================
        // 5. íŒì—… ë° ê¸°ëŠ¥
        // ==========================================
        function generatePopupContent(item, storageKey) {
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const isCompleted = completedList.includes(item.id);
            
            let html = `<div class="popup-container"><div class="popup-title">${item.name}</div><div class="popup-type">â—ˆ ${item.type} â—ˆ</div>`;
            if (item.desc) html += `<div class="popup-desc">${item.desc}</div>`;
            
            if (item.link) {
                html += `<a href="${item.link}" target="_blank" class="action-btn btn-wiki" style="display:block; width:100%; box-sizing:border-box; text-align:center; margin-bottom:8px;">ğŸ“– ê³µëµ ë³´ê¸°</a>`;
            }
            
            html += `<div class="btn-container" style="display:flex; gap:5px; margin-bottom:0;">`;
            html += `<button onclick="shareMarker(${item.id})" class="action-btn" style="flex:1; background:#4a90e2; color:white;">ğŸ”— ê³µìœ </button>`;
            
            const btnText = isCompleted ? "ì·¨ì†Œ" : "ì™„ë£Œ";
            const btnClass = isCompleted ? "btn-undo" : "btn-complete";
            html += `<button onclick="toggleComplete(${item.id}, '${storageKey}')" class="action-btn ${btnClass}" style="flex:1;">${btnText}</button>`;
            html += `</div>`;

            if (item.image) {
                const ytId = getYouTubeId(item.image);
                if (ytId) {
                    html += `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top:10px; border-radius:4px;">
                                <iframe src="https://www.youtube.com/embed/${ytId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe>
                             </div>`;
                } else {
                    html += `<img src="${item.image}" class="popup-img" style="margin-top:10px;">`;
                }
            }
            html += `</div>`;
            return html;
        }

        window.toggleComplete = function(id, storageKey) {
            let list = JSON.parse(localStorage.getItem(storageKey)) || [];
            const index = list.indexOf(id); const target = allMarkers.find(m => m.id === id); 
            if (!target) return;
            const marker = target.marker;

            if (index > -1) { 
                list.splice(index, 1); L.DomUtil.removeClass(marker._icon, 'marker-completed'); 
            } else { 
                list.push(id); L.DomUtil.addClass(marker._icon, 'marker-completed'); 
            }
            localStorage.setItem(storageKey, JSON.stringify(list)); 
            marker.closePopup(); marker.openPopup();
        };

        window.shareMarker = function(id) {
            const url = new URL(window.location.href);
            url.searchParams.set('marker', id);
            copyToClipboard(url.toString());
        };

        // ==========================================
        // 6. ê°œë°œì íˆ´
        // ==========================================
        if (isDevMode) {
            map.on('click', function(e) {
                const y = Math.round(e.latlng.lat);
                const x = Math.round(e.latlng.lng);
                const content = `
                    <div class="input-group">
                        <h4 style="margin:0 0 10px 0; text-align:center; color:#a08040; border-bottom:1px solid #ddd; padding-bottom:5px;">ìƒˆ ìœ„ì¹˜ ê¸°ë¡</h4>
                        <label>ì´ë¦„</label> <input type="text" id="input_name">
                        <label>ì¢…ë¥˜</label> 
                        <select id="input_type" onchange="autoFillDesc(this)">                        
                           <option value="í™”ì¥ì‹¤">í™”ì¥ì‹¤</option>
                        
                            <option value="ì±„ì§‘">ì±„ì§‘</option>
                           <option value="ìƒì">ìƒì</option>
                            <option value="ê²½ê³„ì„">ê²½ê³„ì„</option> 
                            <option value="ë¬˜ë¬˜ëƒ¥">ë¬˜ë¬˜ëƒ¥</option> 
                            <option value="ë¬˜ë¬¼">ë¬˜ë¬¼</option>                           
                            <option value="ê³ ì–‘ì´">ê³ ì–‘ì´</option> 
                            <option value="ë§Œì‚¬ë¡">ë§Œì‚¬ë¡</option>
                        </select>
                        <label>ì„¤ëª…</label> <textarea id="input_desc" style="height:40px;"></textarea>
                        <label>ë§í¬</label> <input type="text" id="input_link">
                        <label>ì‚¬ì§„</label> <input type="text" id="input_image">
                        <button class="copy-btn" onclick="copyMarkerJson(${y}, ${x})">JSON ë³µì‚¬</button>
                    </div>`;
                L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
                setTimeout(() => document.getElementById('input_name')?.focus(), 100);
            });
        }

        window.autoFillDesc = function(selectElement) {
            const descInput = document.getElementById('input_desc');
            const titleInput = document.getElementById('input_name');
            if (selectElement.value === 'ê³ ì–‘ì´') {
                descInput.value = 'ê·€ì—¬ìš´ ê³ ì–‘ì´ë‹¤';
            } else if (selectElement.value === 'ë¬˜ë¬˜ëƒ¥') {
                descInput.value = 'ë°•ì‹ ìŠ¤íƒ¯ì„ ìœ„í•´ í•„ìˆ˜ ì§„í–‰';
                titleInput.value ='ë¬˜ë¬˜ëƒ¥';
            } else if (descInput.value === 'ê·€ì—¬ìš´ ê³ ì–‘ì´ë‹¤') {
                descInput.value = '';
            }else if (selectElement.value === 'ìƒì') {
                titleInput.value ='ìƒì';
            }
        };

        function getYouTubeId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

       // ==========================================
        // â˜… [ìˆ˜ì •ë¨] JSON ë³µì‚¬ ì‹œ ì§€ë„ì— ì„ì‹œ í‘œì‹œ ë‚¨ê¸°ê¸°
        // ==========================================
        window.copyMarkerJson = function(y, x) {
            const name = document.getElementById('input_name').value || "ì´ë¦„ ì—†ìŒ";
            const type = document.getElementById('input_type').value;
            const desc = document.getElementById('input_desc').value || "";
            const link = document.getElementById('input_link').value || "";
            const image = document.getElementById('input_image').value || "";
            const uniqueId = Date.now(); 

            // 1. JSON ìƒì„± ë° ë³µì‚¬
            const jsonString = `
  {
    "id": ${uniqueId},
    "name": "${name}",
    "type": "${type}",
    "y": ${y},
    "x": ${x},
    "desc": "${desc}",
    "link": "${link}",
    "image": "${image}"
  },`;
            copyToClipboard(jsonString);

            // 2. â˜… [ì¶”ê°€ë¨] ì§€ë„ì— ì„ì‹œ ë§ˆì»¤ ì°ê¸° (ìƒˆë¡œê³ ì¹¨ ì „ê¹Œì§€ ìœ ì§€)
            // ëˆˆì— ì˜ ë„ê²Œ 'í˜•ê´‘ ìì£¼ìƒ‰(Magenta)' ì ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
            const tempMarker = L.circleMarker([y, x], {
                color: '#ff00ff',      // í…Œë‘ë¦¬: í˜•ê´‘ ìì£¼ìƒ‰
                fillColor: '#ff00ff',  // ì±„ìš°ê¸°: í˜•ê´‘ ìì£¼ìƒ‰
                fillOpacity: 1,        // íˆ¬ëª…ë„: ë¶ˆíˆ¬ëª…
                radius: 6              // í¬ê¸°
            }).addTo(map);

            // 3. ë§ˆì»¤ ìœ„ì— ì´ë¦„í‘œ ë‹¬ê¸° (í•­ìƒ ë³´ì´ê²Œ)
            tempMarker.bindTooltip(name, { 
                permanent: true, 
                direction: 'top',
                className: 'dev-temp-label' // ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ (ì•„ë˜ CSS ì¶”ê°€)
            });

            // 4. ì…ë ¥ì°½ íŒì—… ë‹«ê¸° (ì‘ì—… í¸ì˜ì„±)
            map.closePopup();
        };

        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
               navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
            }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0";
            document.body.appendChild(ta); ta.focus(); ta.select();
            try { document.execCommand('copy') ? alert("ë³µì‚¬ ì™„ë£Œ!") : prompt("ë³µì‚¬ ì‹¤íŒ¨:", text); } 
            catch (err) { prompt("ì˜¤ë¥˜:", text); }
            document.body.removeChild(ta);
        }
    </script>
</body>
</html>
