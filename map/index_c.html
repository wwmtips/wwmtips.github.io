<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <meta charset="UTF-8">
    <title>ì—°ìš´ í•œêµ­ì–´ ë§µ for Wiki</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5SMVDZTDST"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-5SMVDZTDST');
    </script>
    <meta property="og:type" content="website">
    <meta property="og:description" content="ì—°ìš´ í•œêµ­ ìœ„í‚¤ì—ì„œ ì œê³µí•˜ëŠ” í•œêµ­ì–´ ë§µì…ë‹ˆë‹¤. ìœ„í‚¤ì™€ ì—°ë™ëœ ìƒˆë¡œìš´ ë§µì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.">
    <meta name="description" content="ì—°ìš´ í•œêµ­ ìœ„í‚¤ì—ì„œ ì œê³µí•˜ëŠ” í•œêµ­ì–´ ë§µì…ë‹ˆë‹¤. ìœ„í‚¤ì™€ ì—°ë™ëœ ìƒˆë¡œìš´ ë§µì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.">

    <meta property="og:title" content="ì—°ìš´ í•œêµ­ì–´ ë§µ for Wiki">    
    <meta property="og:image" content="fav/apple-icon-120x120.png">    
    <meta property="og:url" content="https://wwm.tips/">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../map_style.css">
    <link rel="apple-touch-icon" sizes="57x57" href="../fav/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../fav/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../fav/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../fav/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../fav/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../fav/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../fav/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../fav/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../fav/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="../fav/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="../fav/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="../fav/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="../fav/favicon-16x16.png">
<link rel="manifest" href="../fav/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="../fav/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
    <style>
        #map { background: #1a1a1a; }
        .dev-mode-cursor { cursor: crosshair !important; }

        /* =========================================
           â˜… í•€ ë””ìì¸ (ì–‡ì€ í…Œë‘ë¦¬ ë²„ì „)
           ========================================= */
        
        /* 1. í•€ ëª¸í†µ (í°ìƒ‰ ë² ì´ìŠ¤) */
        .pin-marker {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50% 50% 50% 0; /* ë¬¼ë°©ìš¸ ëª¨ì–‘ */
            transform: rotate(-45deg);    /* 45ë„ íšŒì „ */
            
            background: #ffffff;          /* â˜… ëª¸í†µì€ ë¬´ì¡°ê±´ í°ìƒ‰ */
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5); /* ê·¸ë¦¼ì */
            
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            transition: transform 0.2s, z-index 0.2s;
        }

        /* 2. ë‚´ë¶€ ì»¬ëŸ¬ ì› (í¬ê¸°ë¥¼ í‚¤ì›Œì„œ í…Œë‘ë¦¬ë¥¼ ì–‡ê²Œ ë§Œë“¦) */
        .pin-inner-circle {
            width: 88%;  /* â˜… ì—¬ê¸°ë¥¼ í‚¤ì›Œì„œ í°ìƒ‰ í…Œë‘ë¦¬ë¥¼ ì–‡ê²Œ ë§Œë“¦ (ê¸°ì¡´ 76% -> 88%) */
            height: 88%;
            border-radius: 50%;
            
            /* JSì—ì„œ ì£¼ì…í•œ ìƒ‰ìƒ ì ìš© */
            background: var(--pin-color, #555); 
            
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 3. ì•„ì´ì½˜ (í°ìƒ‰, íšŒì „ ë³´ì •) */
        .pin-inner-circle img {
            width: 70%;  
            height: 70%;
            object-fit: contain;
            
            /* í•€ì´ -45ë„ ëŒì•˜ìœ¼ë¯€ë¡œ, ì´ë¯¸ì§€ëŠ” +45ë„ ëŒë ¤ì„œ ë˜‘ë°”ë¡œ ë³´ì´ê²Œ í•¨ */
            transform: rotate(45deg); 
            
            /* ì•„ì´ì½˜ì„ í•˜ì–€ìƒ‰ìœ¼ë¡œ ë³€ê²½ 
            filter: brightness(0) invert(1);*/
            opacity: 1;
        }

        /* í˜¸ë²„ íš¨ê³¼ */
        .pin-marker:hover {
            transform: rotate(-45deg) scale(1.15); /* ì»¤ì§ */
            z-index: 9999;
            cursor: pointer;
        }

        /* ì™„ë£Œëœ ë§ˆì»¤ (íšŒìƒ‰ ì²˜ë¦¬) */
        .marker-completed .pin-inner-circle {
            background: #999 !important; /* íšŒìƒ‰ìœ¼ë¡œ ë®ì–´ì“°ê¸° */
        }
        .marker-completed .pin-marker {
            opacity: 1;
        }
    </style>
</head>
<body>

    <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" onclick="toggleSidebar()">
        <span>â˜°</span> Loading...
    </button>

    <div id="map-sidebar" class="map-sidebar">
        <div class="sidebar-close-btn" onclick="toggleSidebar()">âœ•</div>
        <div class="sidebar-header">
            <div class="map-select-area">
                <label class="sidebar-label">ì§€ì—­ ë³€ê²½</label>
                <select id="sidebar-map-select" class="sidebar-select"></select>
            </div>
            <div class="search-wrapper">
                <input type="text" id="marker-search" class="sidebar-search-input" placeholder="ì´ë¦„ ê²€ìƒ‰">
                <span class="search-icon">ğŸ”</span>
            </div>
            <div class="filter-controls" id="filter-controls-area">
                <button class="filter-control-btn" onclick="setAllFilters(true)">ëª¨ë‘ í‘œì‹œ</button>
                <button class="filter-control-btn" onclick="setAllFilters(false)">ëª¨ë‘ ìˆ¨ê¸°ê¸°</button>
            </div>
        </div>
        <div id="filter-list" class="filter-list-container"></div>
        <div id="search-result-list" class="search-results-container"></div>
    </div>

    <div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // ==========================================
        // 1. ì„¤ì •
        // ==========================================
        const mapsDB = {
            "qinghe": { name: "ì²­í•˜", img: "../qinghe.jpg", json: "../json/qinghe.json", w: 7306, h: 4732 },
            "kaifeng": { name: "ê°œë´‰", img: "../kaifeng.jpg", json: "../json/kaifeng.json", w: 5159, h: 7000 },
            "gm": { name: "ê·€ë¬¸ì‹œì¥", img: "../gm.jpg", json: "../json/gm.json", w: 5482, h: 3534 }
      
        };

        const typeMapping = { 
            "ê²½ê³„ì„": "ic_pin", 
            "ë¬˜ë¬˜ëƒ¥": "ic_mew", 
            "ê³ ì–‘ì´": "ic_cat",
            "ë§Œì‚¬ë¡": "ic_mansa", 
            "ë¬˜ë¬¼": "ic_uni", 
            "ìƒì": "chest", 
            "ë³´ìŠ¤": "ic_boss",
            "ê¸°ì—°": "ic_ki"
        };

        // â˜… [ìƒ‰ìƒ ì„¤ì •] style.cssì˜ í…Œë§ˆ ìƒ‰ìƒ ì ìš©
        const colorMapping = {
            "ìƒì": "#2e7d32",   // í™©ê¸ˆìƒ‰ (ë³´ë¬¼)
            "ë³´ìŠ¤": "#b71c1c",   // ë¶‰ì€ìƒ‰ (ìœ„í—˜)
            "ê³ ì–‘ì´": "#000000",
            "ë¬˜ë¬¼": "#35945f", 
            "ë§Œì‚¬ë¡": "#a08040", // ì´ˆë¡ìƒ‰ (ì •ë³´)
            "ê²½ê³„ì„": "#dfe0ce", // íŒŒë€ìƒ‰ (ì´ë™)
            "ê¸°ì—°": "#f086ab",    // íšŒìƒ‰ (ê¸°íƒ€)
            "ë¬˜ë¬˜ëƒ¥": "#635e85"    // íšŒìƒ‰ (ê¸°íƒ€)
        };

        const urlParams = new URLSearchParams(window.location.search);
        let rawId = urlParams.get('id') || "qinghe";
        const isDevMode = rawId.endsWith('_dev');
        let currentMapId = isDevMode ? rawId.replace('_dev', '') : rawId;

        if (!mapsDB[currentMapId]) currentMapId = "qinghe";
        const currentConfig = mapsDB[currentMapId];
        
        document.title = `${currentConfig.name} - ì—°ìš´ ì§€ë„`;
        const sidebarBtn = document.getElementById('sidebar-toggle-btn');
        if (sidebarBtn) sidebarBtn.innerHTML = `<span>â˜°</span> ${currentConfig.name}`;

        const isMobile = window.innerWidth <= 768;
        
        // í•€ í¬ê¸° (ì´ë¯¸ì§€ í¬ê¸°ë¥¼ í‚¤ì› ìœ¼ë¯€ë¡œ ì „ì²´ í¬ê¸°ëŠ” ì ë‹¹íˆ ìœ ì§€)
        const pinSize = isMobile ? [24, 24] : [30, 30];

        const layerGroups = {}; 
        const allMarkers = []; 

        // ==========================================
        // 2. ì§€ë„ ìƒì„±
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple, minZoom: -5, maxZoom: 2, zoomControl: false, attributionControl: false
        });

        if (isDevMode) document.getElementById('map').classList.add('dev-mode-cursor');

        const bounds = [[0, 0], [currentConfig.h, currentConfig.w]];
        L.imageOverlay(currentConfig.img, bounds).addTo(map);

        const zoomSettings = { pc: -1.5, mobile: -2.5 };
        const targetZoom = isMobile ? zoomSettings.mobile : zoomSettings.pc;
        map.setView([currentConfig.h / 2, currentConfig.w / 2], targetZoom);

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        map.addControl(new (L.Control.extend({
            options: { position: 'bottomright' },
            onAdd: function () {
                const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const b = L.DomUtil.create('a', 'leaflet-control-fullscreen', c);
                b.href = '#'; b.innerHTML = 'â›¶'; b.onclick = (e) => { e.preventDefault(); toggleFullscreen(); };
                return c;
            }
        }))());

        const mapSelect = document.getElementById('sidebar-map-select');
        for (const [key, val] of Object.entries(mapsDB)) {
            const option = document.createElement('option');
            option.value = key; option.innerText = val.name;
            if (key === currentMapId) option.selected = true;
            mapSelect.appendChild(option);
        }
        mapSelect.onchange = function() {
            const nextId = this.value + (isDevMode ? '_dev' : '');
            window.location.search = `?id=${nextId}`;
        };

        // ==========================================
        // 3. ë°ì´í„° ë¡œë”© & í•€ ë§ˆì»¤ ìƒì„±
        // ==========================================
        fetch(currentConfig.json)
            .then(res => res.json())
            .then(data => {
                createMarkers(data);
                generateSidebar(data);
            })
            .catch(err => { console.error(err); });

       function createMarkers(data) {
            const storageKey = `completed_${currentMapId}`;
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];

            data.forEach(item => {
                
                // â˜… [ê·¸ë£¹ ìƒì„±] íƒ€ì…ë³„ë¡œ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ì„ ë§Œë“­ë‹ˆë‹¤. (ê°™ì€ íƒ€ì…ë¼ë¦¬ë§Œ ë¬¶ì„)
                if (!layerGroups[item.type]) {
                    
                    // 1. í˜„ì¬ íƒ€ì…ì˜ ë””ìì¸ ì •ë³´(ì´ë¯¸ì§€, ìƒ‰ìƒ)ë¥¼ ë¯¸ë¦¬ í™•ì •í•©ë‹ˆë‹¤.
                    // (í´ë¡œì €ë¥¼ í†µí•´ iconCreateFunction ë‚´ë¶€ì—ì„œ ì´ ë³€ìˆ˜ë“¤ì„ ì”ë‹ˆë‹¤)
                    const typeImgName = typeMapping[item.type] || "stone";
                    const typeIconPath = `../images/${typeImgName}.png`;
                    const typeColor = colorMapping[item.type] || "#555";

                    layerGroups[item.type] = L.markerClusterGroup({
                        disableClusteringAtZoom: 0, // ì¤Œ ë‹¹ê¸°ë©´ í©ì–´ì§
                        spiderfyOnMaxZoom: true,    // ìµœëŒ€ ì¤Œì—ì„œ í´ë¦­í•˜ë©´ ë²Œì–´ì§
                        showCoverageOnHover: false, 
                        chunkedLoading: true,       // ì„±ëŠ¥ ìµœì í™”

                        // â˜… [ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜]
                        iconCreateFunction: function(cluster) {
                            const count = cluster.getChildCount(); // ë­‰ì³ì§„ ê°œìˆ˜
                            
                            // HTML: ê¸°ì¡´ í•€ ë””ìì¸(.pin-marker) + ë±ƒì§€(.cluster-badge-count)
                            const html = `
                                <div class="badge-cluster-container">
                                    <div class="pin-marker">
                                        <div class="pin-inner-circle" style="--pin-color: ${typeColor};">
                                            <img src="${typeIconPath}" onerror="this.src='../images/stone.png'">
                                        </div>
                                    </div>
                                    
                                    <div class="cluster-badge-count">${count}</div>
                                </div>
                            `;

                            return L.divIcon({
                                html: html,
                                className: '',     // Leaflet ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±°
                                iconSize: pinSize, // ë‹¨ì¼ í•€ê³¼ ë™ì¼í•œ í¬ê¸°
                                iconAnchor: [pinSize[0]/2, pinSize[1] * 0.9]
                            });
                        }
                    });
                }

                const isCompleted = completedList.includes(item.id);
                
                const imgName = typeMapping[item.type] || "stone"; 
                const iconPath = `../images/${imgName}.png`;
                const pinColor = colorMapping[item.type] || colorMapping["ê¸°íƒ€"];

                // ì¼ë°˜ ë§ˆì»¤ ì•„ì´ì½˜
                const pinIcon = L.divIcon({
                    className: isCompleted ? 'marker-completed' : '',
                    html: `<div class="pin-marker">
                               <div class="pin-inner-circle" style="--pin-color: ${pinColor};">
                                   <img src="${iconPath}" onerror="this.src='../images/stone.png'">
                               </div>
                           </div>`,
                    iconSize: pinSize, 
                    iconAnchor: [pinSize[0]/2, pinSize[1] * 0.9], 
                    popupAnchor: [0, -(pinSize[1] * 0.8)]
                });

                const marker = L.marker([item.y, item.x], { icon: pinIcon });
                marker.bindPopup(() => generatePopupContent(item, storageKey));
                
                // í•´ë‹¹ íƒ€ì… ê·¸ë£¹ì— ì¶”ê°€
                layerGroups[item.type].addLayer(marker);
                allMarkers.push({ id: item.id, name: item.name, desc: item.desc || "", type: item.type, marker: marker });
            });

            // ê·¸ë£¹ì„ ì§€ë„ì— í‘œì‹œ
            for (const key in layerGroups) layerGroups[key].addTo(map);

            // https://math-development-geometry.tistory.com/50
            const targetId = urlParams.get('marker');
            if (targetId) {
                const target = allMarkers.find(m => m.id == targetId);
                if (target) {
                    if (!map.hasLayer(layerGroups[target.type])) {
                        map.addLayer(layerGroups[target.type]);
                        const checkbox = Array.from(document.querySelectorAll('.filter-checkbox'))
                                              .find(cb => cb.parentElement.innerText.includes(target.type));
                        if (checkbox) checkbox.checked = true;
                    }
                    layerGroups[target.type].zoomToShowLayer(target.marker, function() {
                        target.marker.openPopup();
                    });
                }
            }
        }

        // ==========================================
        // 4. ì‚¬ì´ë“œë°” ë¡œì§
        // ==========================================
        const searchInput = document.getElementById('marker-search');
        const filterList = document.getElementById('filter-list');
        const searchResultList = document.getElementById('search-result-list');
        const filterControls = document.getElementById('filter-controls-area');

        searchInput.addEventListener('input', function(e) {
            const keyword = e.target.value.trim().toLowerCase();
            if (keyword === "") {
                filterList.classList.remove('hidden'); filterControls.style.display = 'flex'; searchResultList.classList.remove('active'); return;
            }
            filterList.classList.add('hidden'); filterControls.style.display = 'none'; searchResultList.classList.add('active'); searchResultList.innerHTML = '';
            const results = allMarkers.filter(item => item.name.toLowerCase().includes(keyword) || item.desc.toLowerCase().includes(keyword));
            if (results.length === 0) { searchResultList.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            results.forEach(item => {
                const row = document.createElement('div'); row.className = 'search-result-row';
                const imgName = typeMapping[item.type] || "stone";
                row.innerHTML = `<div class="result-info"><div class="result-name">${item.name}</div><div class="result-desc">${item.desc}</div></div><img src="../images/${imgName}.png" class="result-type-icon" onerror="this.style.display='none'">`;
                row.onclick = () => {
                    if (!map.hasLayer(layerGroups[item.type])) map.addLayer(layerGroups[item.type]);
                    const jumpZoom = Math.min(map.getZoom() + 3, 1); 
                    map.flyTo(item.marker.getLatLng(), jumpZoom, { animate: true, duration: 1.5 });
                    setTimeout(() => { item.marker.openPopup(); }, 1000);
                    if (window.innerWidth <= 480) toggleSidebar();
                };
                searchResultList.appendChild(row);
            });
        });

        function generateSidebar(data) {
            filterList.innerHTML = '';
            const counts = {};
            data.forEach(item => counts[item.type] = (counts[item.type] || 0) + 1);
            for (const [type, count] of Object.entries(counts)) {
                const div = document.createElement('div'); div.className = 'filter-item'; 
                const imgName = typeMapping[type] || "stone";
                div.innerHTML = `<label class="filter-label" style="cursor:pointer; width:100%;"><input type="checkbox" class="filter-checkbox" checked onchange="toggleLayer('${type}', this.checked)"><img src="../images/${imgName}.png" width="24" height="24" onerror="this.style.display='none'" style="vertical-align:middle; margin-right:5px;"> ${type}</label><span class="filter-count">${count}</span>`;
                filterList.appendChild(div);
            }
        }
        function toggleLayer(type, isChecked) { isChecked ? map.addLayer(layerGroups[type]) : map.removeLayer(layerGroups[type]); }
        function setAllFilters(status) { document.querySelectorAll('.filter-checkbox').forEach(cb => { cb.checked = status; const type = cb.parentElement.innerText.trim(); toggleLayer(type, status); }); }
        function toggleSidebar() { document.getElementById('map-sidebar').classList.toggle('open'); }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {}); else if (document.exitFullscreen) document.exitFullscreen(); }
        
              function generatePopupContent(item, storageKey) {
            const completedList = JSON.parse(localStorage.getItem(storageKey)) || [];
            const isCompleted = completedList.includes(item.id);
            
            let html = `<div class="popup-container"><div class="popup-title">${item.name}</div><div class="popup-type">â—ˆ ${item.type} â—ˆ</div>`;
            
            if (item.desc) html += `<div class="popup-desc">${item.desc}</div>`;
            
            // â˜… [ìˆ˜ì • 1] ê³µëµ ë³´ê¸°ê°€ ìˆìœ¼ë©´ ê°€ì¥ ìœ—ì¤„ì— ê½‰ ì°¨ê²Œ ë°°ì¹˜
            if (item.link) {
                html += `<a href="${item.link}" target="_blank" class="action-btn btn-wiki" style="display:block; width:100%; box-sizing:border-box; text-align:center; margin-bottom:8px;">ğŸ“– ê³µëµ ë³´ê¸°</a>`;
            }
            
            // â˜… [ìˆ˜ì • 2] ê³µìœ ì™€ ì™„ë£Œ ë²„íŠ¼ì€ ê·¸ ì•„ë˜ í•œ ì¤„ì— ë‚˜ë€íˆ (flex ì‚¬ìš©)
            html += `<div class="btn-container" style="display:flex; gap:5px; margin-bottom:0;">`;
            
            // ê³µìœ  ë²„íŠ¼ (flex:1 ë¡œ ë°˜ë°˜ ì°¨ì§€)
            html += `<button onclick="shareMarker(${item.id})" class="action-btn" style="flex:1; background:#4a90e2; color:white;">ğŸ”— ê³µìœ </button>`;

            // ì™„ë£Œ ë²„íŠ¼ (flex:1 ë¡œ ë°˜ë°˜ ì°¨ì§€)
            const btnText = isCompleted ? "ì·¨ì†Œ" : "ì™„ë£Œ";
            const btnClass = isCompleted ? "btn-undo" : "btn-complete";
            html += `<button onclick="toggleComplete(${item.id}, '${storageKey}')" class="action-btn ${btnClass}" style="flex:1;">${btnText}</button>`;
            
            html += `</div>`; // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ë‹«ê¸°

            // ì´ë¯¸ì§€/ìœ íŠœë¸Œ ì²˜ë¦¬
            if (item.image) {
                const ytId = getYouTubeId(item.image);
                if (ytId) {
                    html += `
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top:10px; border-radius:4px;">
                            <iframe src="https://www.youtube.com/embed/${ytId}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                            </iframe>
                        </div>`;
                } else {
                    html += `<img src="${item.image}" class="popup-img" style="margin-top:10px;">`;
                }
            }

            html += `</div>`;
            return html;
        }


        window.toggleComplete = function(id, storageKey) {
            let list = JSON.parse(localStorage.getItem(storageKey)) || [];
            const index = list.indexOf(id); const target = allMarkers.find(m => m.id === id); 
            if (!target) return;
            const marker = target.marker;

            if (index > -1) { 
                list.splice(index, 1); 
                L.DomUtil.removeClass(marker._icon, 'marker-completed'); 
            } else { 
                list.push(id); 
                L.DomUtil.addClass(marker._icon, 'marker-completed'); 
            }
            localStorage.setItem(storageKey, JSON.stringify(list)); 
            marker.closePopup(); 
            marker.openPopup();
        };
                // â˜… [ëˆ„ë½ëœ í•¨ìˆ˜ ë³µêµ¬] í˜„ì¬ ìœ„ì¹˜ ê³µìœ  ë§í¬ ìƒì„± ë° ë³µì‚¬
        window.shareMarker = function(id) {
            // í˜„ì¬ í˜ì´ì§€ì˜ ê¸°ë³¸ URL ê°€ì ¸ì˜¤ê¸°
            const url = new URL(window.location.href);
            
            // marker íŒŒë¼ë¯¸í„° ì„¤ì • (ê¸°ì¡´ id íŒŒë¼ë¯¸í„° ë“±ì€ ìœ ì§€ë¨)
            url.searchParams.set('marker', id);
            
            // í´ë¦½ë³´ë“œì— ë³µì‚¬ í•¨ìˆ˜ í˜¸ì¶œ
            copyToClipboard(url.toString());
        };

// ==========================================
        // 5. ê°œë°œì íˆ´
        // ==========================================
        if (isDevMode) {
            map.on('click', function(e) {
                const y = Math.round(e.latlng.lat);
                const x = Math.round(e.latlng.lng);
                
                // onchange="autoFillDesc(this)" ì¶”ê°€ë¨
                const content = `
                    <div class="input-group">
                        <h4 style="margin:0 0 10px 0; text-align:center; color:#a08040; border-bottom:1px solid #ddd; padding-bottom:5px;">ìƒˆ ìœ„ì¹˜ ê¸°ë¡</h4>
                        <label>ì´ë¦„</label> <input type="text" id="input_name">
                        <label>ì¢…ë¥˜</label> 
                        <select id="input_type" onchange="autoFillDesc(this)">
                            <option value="ë¬˜ë¬˜ëƒ¥">ë¬˜ë¬˜ëƒ¥</option>
                            <option value="ê¸°ì—°">ê¸°ì—°</option>
                             <option value="ë¬˜ë¬¼">ë¬˜ë¬¼</option>
                             <option value="ê²½ê³„ì„">ê²½ê³„ì„</option>                           
                            <option value="ê³ ì–‘ì´">ê³ ì–‘ì´</option>
                            <option value="ìƒì">ìƒì</option>
                            <option value="ë§Œì‚¬ë¡">ë§Œì‚¬ë¡</option>
                            <option value="ë³´ìŠ¤">ë³´ìŠ¤</option>
                            
                        </select>
                        <label>ì„¤ëª…</label> <textarea id="input_desc" style="height:40px;"></textarea>
                        <label>ë§í¬</label> <input type="text" id="input_link">
                        <label>ì‚¬ì§„</label> <input type="text" id="input_image">
                        <button class="copy-btn" onclick="copyMarkerJson(${y}, ${x})">JSON ë³µì‚¬</button>
                    </div>
                `;
                L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
                setTimeout(() => document.getElementById('input_name')?.focus(), 100);
            });
        }

        // [ì¶”ê°€ëœ í•¨ìˆ˜] ê³ ì–‘ì´ ì„ íƒ ì‹œ ì„¤ëª… ìë™ ì…ë ¥
        window.autoFillDesc = function(selectElement) {
            const descInput = document.getElementById('input_desc');
            const titleInput = document.getElementById('input_name');
            if (selectElement.value === 'ê³ ì–‘ì´') {
                descInput.value = 'ê·€ì—¬ìš´ ê³ ì–‘ì´ë‹¤';
            }else if (selectElement.value === 'ë¬˜ë¬˜ëƒ¥') {
                descInput.value = 'ë°•ì‹ ìŠ¤íƒ¯ì„ ìœ„í•´ í•„ìˆ˜ ì§„í–‰';
                titleInput.value ='ë¬˜ë¬˜ëƒ¥';
            } else if (descInput.value === 'ê·€ì—¬ìš´ ê³ ì–‘ì´ë‹¤') {
                // (ì˜µì…˜) ë§Œì•½ ë‹¤ë¥¸ ê±¸ë¡œ ë°”ê¿¨ëŠ”ë° ë‚´ìš©ì´ 'ê·€ì—¬ìš´ ê³ ì–‘ì´ë‹¤' ê·¸ëŒ€ë¡œë©´ ì§€ì›Œì¤Œ
                descInput.value = '';
            }
        };
// ìœ íŠœë¸Œ URLì—ì„œ ID ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
function getYouTubeId(url) {
    if (!url) return null;
    // ì¼ë°˜ ì£¼ì†Œ(youtube.com)ì™€ ë‹¨ì¶• ì£¼ì†Œ(youtu.be) ëª¨ë‘ ì²˜ë¦¬
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}
        window.copyMarkerJson = function(y, x) {
            const name = document.getElementById('input_name').value || "ì´ë¦„ ì—†ìŒ";
            const type = document.getElementById('input_type').value;
            const desc = document.getElementById('input_desc').value || "";
            const link = document.getElementById('input_link').value || "";
            const image = document.getElementById('input_image').value || "";
            const uniqueId = Date.now(); 

            const jsonString = `
  {
    "id": ${uniqueId},
    "name": "${name}",
    "type": "${type}",
    "y": ${y},
    "x": ${x},
    "desc": "${desc}",
    "link": "${link}",
    "image": "${image}"
  },`;
            copyToClipboard(jsonString);
        };

        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ ì™„ë£Œ!")).catch(() => fallbackCopy(text));
            } else { fallbackCopy(text); }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0";
            document.body.appendChild(ta); ta.focus(); ta.select();
            try { document.execCommand('copy') ? alert("ë³µì‚¬ ì™„ë£Œ!") : prompt("ë³µì‚¬ ì‹¤íŒ¨:", text); } 
            catch (err) { prompt("ì˜¤ë¥˜:", text); }
            document.body.removeChild(ta);
        }
    </script>
    
</body>
</html>
