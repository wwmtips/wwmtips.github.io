<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì²­í•˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="map_style.css">
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================
        // 1. ì„¤ì • (Config)
        // ==========================================
        const config = {
            imageUrl: '1000027025.jpg',   // â˜… í˜„ì¬ ë§µ ì´ë¯¸ì§€
            imageWidth: 7306,
            imageHeight: 4732,
            iconSize: [24, 24],
            jsonPath: 'json/data.json'
        };

        // â˜… ë§µ ë¦¬ìŠ¤íŠ¸ ì„¤ì • (ë‚˜ì¤‘ì— ì—¬ê¸°ì— ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤)
        const mapList = [
            { name: "ì²­í•˜", url: "map_qinghe.html" }, // í˜„ì¬ íŒŒì¼
            { name: "ê°œë´‰", url: "map_kaifeng.html" } // ë‚˜ì¤‘ì— ë§Œë“¤ íŒŒì¼
        ];

        // í˜„ì¬ í˜ì´ì§€ì˜ íŒŒì¼ëª… ì•Œì•„ë‚´ê¸° (ë“œë¡­ë‹¤ìš´ ì„ íƒ ìƒíƒœìš©)
        const currentPage = window.location.pathname.split("/").pop();

        const typeMapping = {
            "ê²½ê³„ì„": "stone",
            "ìƒì": "chest",
            "ë§Œì‚¬ë¡":"ic_mansa",
            "ë³´ìŠ¤": "boss"
        };
        
        const allMarkers = {};

        // ==========================================
        // 2. ì§€ë„ ì´ˆê¸°í™”
        // ==========================================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 2,
            zoomSnap: 0.5,
            zoomDelta: 0.5,
            zoomControl: false,       // â˜… ê¸°ë³¸ ì¤Œ ì»¨íŠ¸ë¡¤ ë„ê¸° (ìœ„ì¹˜ ì´ë™ì„ ìœ„í•´)
            attributionControl: false 
        });

        const bounds = [[0, 0], [config.imageHeight, config.imageWidth]];
        L.imageOverlay(config.imageUrl, bounds).addTo(map);

        // ì´ˆê¸° í™”ë©´ ì„¤ì •
        var centerY = config.imageHeight / 2;
        var centerX = config.imageWidth / 2;
        var initialZoom = -2.5; 
        
        map.setView([centerY, centerX], initialZoom);


        // ==========================================
        // 3. ì»¨íŠ¸ë¡¤ ë°°ì¹˜ (ì¤Œ, ì „ì²´í™”ë©´, ë§µ ë³€ê²½)
        // ==========================================

        // [3-1] ì¤Œ ì»¨íŠ¸ë¡¤ -> ì˜¤ë¥¸ìª½ í•˜ë‹¨ (bottomright)
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);


        // [3-2] ì „ì²´í™”ë©´ ë²„íŠ¼ -> ì™¼ìª½ í•˜ë‹¨ (bottomleft) ìœ ì§€
        const FullscreenControl = L.Control.extend({
            options: { position: 'bottomleft' },
            onAdd: function (map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const button = L.DomUtil.create('a', 'leaflet-control-fullscreen', container);
                button.href = '#';
                button.title = 'ì „ì²´í™”ë©´ ë³´ê¸°';
                button.innerHTML = 'â›¶'; 
                button.onclick = function(e) {
                    e.preventDefault();
                    toggleFullscreen();
                }
                return container;
            }
        });
        map.addControl(new FullscreenControl());


        // [3-3] ë§µ ë³€ê²½(Switcher) -> ì˜¤ë¥¸ìª½ ìƒë‹¨ (topright)
        const MapSwitcherControl = L.Control.extend({
            options: { position: 'topright' }, // â˜… ìš°ì¸¡ ìƒë‹¨ ë°°ì¹˜

            onAdd: function (map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control map-switcher-control');
                
                // ì•„ì´ì½˜ (ì„ íƒì‚¬í•­)
                const icon = L.DomUtil.create('span', 'map-switcher-icon', container);
                icon.innerHTML = 'ğŸ—ºï¸ ';

                // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ (Select)
                const select = L.DomUtil.create('select', 'map-switcher-select', container);
                
                // ë§µ ë¦¬ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜µì…˜ ìƒì„±
                mapList.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.url;
                    option.innerText = m.name;
                    
                    // í˜„ì¬ í˜ì´ì§€ì™€ URLì´ ê°™ìœ¼ë©´ ì„ íƒëœ ìƒíƒœë¡œ í‘œì‹œ
                    if (currentPage === m.url) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                // ì„ íƒ ë³€ê²½ ì‹œ í˜ì´ì§€ ì´ë™ ì´ë²¤íŠ¸
                select.onchange = function() {
                    if (this.value) {
                        window.location.href = this.value;
                    }
                };

                // ë“œë¡­ë‹¤ìš´ í´ë¦­ ì‹œ ì§€ë„ê°€ ê°™ì´ í´ë¦­ë˜ëŠ” ê²ƒ ë°©ì§€
                L.DomEvent.disableClickPropagation(container);

                return container;
            }
        });
        map.addControl(new MapSwitcherControl());


        // ==========================================
        // 4. ê¸°ëŠ¥ ë¡œì§ (ì „ì²´í™”ë©´, ë°ì´í„° ë¡œë”© ë“±)
        // ==========================================

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`ì „ì²´í™”ë©´ ì˜¤ë¥˜: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // ë°ì´í„° ë¡œë”©
        fetch(config.jsonPath)
            .then(res => res.json())
            .then(data => createMarkers(data))
            .catch(err => {
                console.error(err);
                alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨! (VS Code Live Server í™•ì¸)');
            });

        function createMarkers(data) {
            const layerGroups = {};
            const completedList = JSON.parse(localStorage.getItem('completedMarkers')) || [];

            data.forEach(item => {
                if (!layerGroups[item.type]) layerGroups[item.type] = L.layerGroup();
                const imgName = typeMapping[item.type] || item.type;
                const isCompleted = completedList.includes(item.id);

                const myIcon = L.icon({
                    iconUrl: `images/${imgName}.png`,
                    iconSize: config.iconSize,
                    iconAnchor: [config.iconSize[0]/2, config.iconSize[1]], 
                    popupAnchor: [0, -config.iconSize[1]],
                    className: isCompleted ? 'marker-completed' : ''
                });

                const marker = L.marker([item.y, item.x], { icon: myIcon });
                allMarkers[item.id] = marker;
                marker.bindPopup(() => generatePopupContent(item));
                layerGroups[item.type].addLayer(marker);
            });

            for (const key in layerGroups) layerGroups[key].addTo(map);
            L.control.layers(null, layerGroups, { collapsed: false }).addTo(map);
        }

        function generatePopupContent(item) {
            const completedList = JSON.parse(localStorage.getItem('completedMarkers')) || [];
            const isCompleted = completedList.includes(item.id);

            let html = `<div class="popup-container">
                <div class="popup-title">${item.name}</div>
                <div class="popup-type">â—ˆ ${item.type} â—ˆ</div>`;

            if (item.desc && item.desc.trim() !== "") {
                html += `<div class="popup-desc">${item.desc}</div>`;
            }

            html += `<div class="btn-container">`;
            if (item.link && item.link.trim() !== "") {
                html += `<a href="${item.link}" target="_blank" class="action-btn btn-wiki">ì§€ì¹¨ì„œ</a>`;
            }

            const btnText = isCompleted ? "ì·¨ì†Œ" : "ì™„ë£Œ";
            const btnClass = isCompleted ? "btn-undo" : "btn-complete";
            html += `<button onclick="toggleComplete(${item.id})" class="action-btn ${btnClass}">${btnText}</button>`;
            html += `</div>`; 

            if (item.image && item.image.trim() !== "") {
                html += `<img src="${item.image}" class="popup-img">`;
            }
            html += `</div>`;
            return html;
        }

        window.toggleComplete = function(id) {
            let completedList = JSON.parse(localStorage.getItem('completedMarkers')) || [];
            const index = completedList.indexOf(id);
            const marker = allMarkers[id];
            if (!marker) return;

            if (index > -1) {
                completedList.splice(index, 1);
                L.DomUtil.removeClass(marker._icon, 'marker-completed');
            } else {
                completedList.push(id);
                L.DomUtil.addClass(marker._icon, 'marker-completed');
            }
            localStorage.setItem('completedMarkers', JSON.stringify(completedList));
            marker.closePopup(); marker.openPopup();
        };

        // (ê°œë°œìš©) ì§€ë„ í´ë¦­ ì‹œ ì¢Œí‘œ ë° JSON ë³µì‚¬
        map.on('click', function(e) {
            const y = Math.round(e.latlng.lat);
            const x = Math.round(e.latlng.lng);

            const content = `
                <div class="input-group">
                    <h4 style="margin:0 0 10px 0; text-align:center; color:#a08040; border-bottom:1px solid #ddd; padding-bottom:5px;">ìƒˆ ìœ„ì¹˜ ê¸°ë¡</h4>
                    <label>ì´ë¦„ (Name)</label> <input type="text" id="input_name">
                    <label>ì¢…ë¥˜ (Type)</label> 
                    <select id="input_type">
                        <option value="ê²½ê³„ì„">ê²½ê³„ì„</option>
                        <option value="ìƒì">ìƒì</option>
                        <option value="ë³´ìŠ¤">ë³´ìŠ¤</option>
                    </select>
                    <label>ì„¤ëª… (Desc)</label> <textarea id="input_desc" style="height:40px;"></textarea>
                    <label>ë§í¬ (Link)</label> <input type="text" id="input_link">
                    <label>ì‚¬ì§„ (Image)</label> <input type="text" id="input_image">
                    <button class="copy-btn" onclick="copyMarkerJson(${y}, ${x})">JSON ë³µì‚¬ (Copy)</button>
                </div>
            `;
            L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
            setTimeout(() => document.getElementById('input_name')?.focus(), 100);
        });

        window.copyMarkerJson = function(y, x) {
            const name = document.getElementById('input_name').value || "ì´ë¦„ ì—†ìŒ";
            const type = document.getElementById('input_type').value;
            const desc = document.getElementById('input_desc').value;
            const link = document.getElementById('input_link').value;
            const image = document.getElementById('input_image').value;
            const uniqueId = Date.now(); 

            const jsonString = `,
  {
    "id": ${uniqueId},
    "name": "${name}",
    "type": "${type}",
    "y": ${y},
    "x": ${x},
    "desc": "${desc}",
    "link": "${link}",
    "image": "${image}"
  }`;
            copyToClipboard(jsonString);
        };

        window.copyToClipboard = function(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ ì™„ë£Œ!")).catch(() => fallbackCopy(text));
            } else { fallbackCopy(text); }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0";
            document.body.appendChild(ta); ta.focus(); ta.select();
            try { document.execCommand('copy') ? alert("ë³µì‚¬ ì™„ë£Œ!") : prompt("ë³µì‚¬ ì‹¤íŒ¨:", text); } 
            catch (err) { prompt("ì˜¤ë¥˜:", text); }
            document.body.removeChild(ta);
        }
    </script>
</body>
</html>
